<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/bb.png">
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budgety Buddy</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-bg: #f4f7f9; --secondary-bg: #ffffff; --text-color: #333; --accent-color: #4a90e2; --accent-hover: #357abd; --income-color: #2ecc71; --expense-color: #e74c3c; --border-color: #e0e0e0; --shadow: 0 4px 8px rgba(0,0,0,0.1);
            /* Challenge Theme Colors */
            --challenge-gold: #FFD700;
            --challenge-dark-gold: #D4AF37;
            --challenge-bg: #FFFBEA;
            --challenge-text: #4a3f00;
        }
        * { box-sizing: border-box; }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--primary-bg); color: var(--text-color); margin: 0; padding: 20px; font-size: 16px; }
        .container { 
            max-width: 800px; margin: 0 auto; background-color: var(--secondary-bg); 
            border-radius: 10px; box-shadow: var(--shadow); padding: 20px;
            position: relative;
        }
        #app-logo {
            position: absolute;
            top: 25px;
            left: 25px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Cambria', 'Times New Roman', Times, serif;
            font-style: italic;
            font-weight: 700;
            font-size: 1.15em;
        }
        /* --- START: UPDATED HEADER STYLES --- */
        header { 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 20px;
            margin-bottom: 20px; 
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover)); 
            color: white; 
            border-radius: 8px; 
            position: relative; 
        }
        #app-title-logo {
            height: 100px;
            width: auto;
        }
        /* Reset margins on header items to let 'gap' control the spacing */
        header > *, header div > * {
            margin: 0;
        }
        header #current-month {
            margin-top: 2px;
        }
        header #manage-accounts-btn {
            margin-top: 8px;
        }
        /* --- END: UPDATED HEADER STYLES --- */
        h1 { color: white; margin: 0; font-family: 'Cambria', 'Times New Roman', Times, serif; font-style: italic; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.18); }
        #current-account-name { color: rgba(255,255,255,0.95); }
        #current-account-name {
            font-size: 1.6em;
            color: #555;
        }
    .summary-display { background: linear-gradient(135deg, var(--accent-color), var(--accent-hover)); color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
    .summary-display h2 { margin: 0; font-size: 1.2em; font-weight: 500; color: white; }
    /* specifically target the big remaining amount so we can add a smaller red spent line below */
    .summary-display #remaining-to-spend { font-size: 2.5em; font-weight: bold; margin: 5px 0 0; }
    .summary-display .amount-spent { font-size: 0.95em; color: var(--expense-color); margin: 6px 0 0; font-weight: 600; opacity: 0.98; }
        .section { margin-bottom: 25px; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; transition: background-color: 0.3s, border-color: 0.3s; }
        .section-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 10px; }
        .section-header h3 { margin: 0; }
        .toggle-icon { font-size: 1.5em; transition: transform 0.3s; }
        .section.collapsed .section-content, .section.collapsed .add-category-btn, .section.collapsed .hidden-form { display: none; }
        .section.collapsed > .section-header { margin-bottom: 0; border-bottom: none; }
        .section.collapsed .section-summary-view { display: flex; justify-content: space-around; background-color: #f7f7f7; padding: 10px; border-radius: 5px; font-size: 0.9em; }
        .section.collapsed > .section-header .toggle-icon { transform: rotate(-90deg); }
        .input-group { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .input-group:last-child { margin-bottom: 0; }
        .input-group input, .input-group select { flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; width: 100%; }
        button { padding: 10px 15px; border: none; border-radius: 5px; background-color: var(--accent-color); color: white; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: var(--accent-hover); }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 1.2em; padding: 5px; flex-shrink: 0; }
        .delete-btn { color: var(--expense-color); }
        .edit-btn { color: var(--accent-color); }
        .add-category-btn { width: 100%; margin-top: 10px; background-color: #f0f0f0; color: var(--text-color); }
        .category-controls { display: flex; gap: 5px; }
        .control-btn { font-size: 0.8em; padding: 5px 10px; background-color: #e9e9e9; color: var(--text-color); }
        .budget-category { border: 1px solid var(--border-color); border-radius: 5px; padding: 10px; background-color: #fafafa; margin-bottom: 10px; }
        .budget-category:last-child { margin-bottom: 0; }
        .budget-category-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: bold; }
        .budget-category.collapsed .toggle-icon { transform: rotate(-90deg); }
        .budget-category.collapsed .budget-category-content,
        .budget-category.collapsed .edit-category-form { display: none; }
        .budget-category-content { margin-top: 10px; }
        .budget-summary-text { font-size: 0.9em; font-weight: normal; color: #555; margin-top: 5px; }
        .progress-bar { width: 100%; background-color: #e0e0e0; border-radius: 5px; height: 10px; margin-top: 8px; overflow: hidden; position: relative; }
        .progress-bar-inner { height: 100%; border-radius: 5px; transition: width 0.4s ease-in-out, background-color 0.4s ease-in-out; position: absolute; top: 0; left: 0; }
        .progress-bar-remaining { background-color: var(--income-color); }
        .progress-bar-overspent { background-color: var(--expense-color); }
        .edit-category-form, .edit-expense-form { padding: 10px; background-color: #eaf2fa; border-radius: 5px; margin-bottom: 10px; }
        .expense-log { list-style: none; padding: 0; margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .expense-log li { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; font-size: 0.9em; flex-wrap: wrap; }
        .expense-log .date-stamp { color: #888; font-size: 0.9em; margin: 0 10px; flex-shrink: 0; white-space: nowrap; }
        .expense-log .amount { font-weight: 500; margin-right: 5px; }
        .expense-log .note { color: #777; font-style: italic; margin-left: 5px; flex-grow: 1; word-break: break-all; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        #confirm-modal, #prompt-modal, #rollover-modal, #quick-add-modal { z-index: 1010; }
        .modal-content { background-color: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; }
        #confirm-modal .modal-content, #onboarding-modal .modal-content, #accounts-modal .modal-content, #prompt-modal .modal-content, #quick-add-modal .modal-content { max-width: 400px; text-align: center; }
        #accounts-modal .modal-content, #rollover-modal .modal-content { max-width: 500px; text-align: left;}
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .modal-header .close-btn { font-size: 1.8em; cursor: pointer; background: none; border: none; padding: 0 10px; color: #333; }
        .chart-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        #comparison-charts-area .chart-container { grid-template-columns: 1fr; }
        .confirm-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        #onboarding-modal { display: flex; }
        .app-content { display: none; }
        
        .reorder-controls { display: none; align-items: center; margin-right: 10px; gap: 5px; }
        .reordering-active .reorder-controls { display: inline-flex; }
        .move-btn { background: none; border: 1px solid #ccc; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 1em; padding: 0; line-height: 26px; color: var(--text-color); }
        .move-btn:hover { background-color: #f0f0f0; }
        .move-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .reordering-active .budget-category-header .edit-btn, .reordering-active .budget-category-header .delete-btn { display: none; }

        #challenge-center-btn { padding: 12px 20px; font-size: 1.1em; font-weight: 600; background-color: var(--challenge-dark-gold); border: 1px solid var(--challenge-gold); line-height: 1.4; }
        #challenge-center-btn:hover { background-color: var(--challenge-gold); color: var(--challenge-text); }
        #challenge-modal .modal-content { background-color: var(--challenge-bg); color: var(--challenge-text); border: 2px solid var(--challenge-dark-gold); }
        #challenge-modal .modal-header { background: linear-gradient(135deg, var(--challenge-gold), var(--challenge-dark-gold)); color: var(--challenge-text); padding: 15px 25px; margin: -25px -25px 20px -25px; border-top-left-radius: 8px; border-top-right-radius: 8px; border-bottom: 2px solid var(--challenge-dark-gold); position: sticky; top: -25px; z-index: 10; }
        #challenge-modal .modal-header .close-btn { color: var(--challenge-text); }
        #challenge-modal .challenge-section h3 { border-bottom: 1px solid var(--challenge-dark-gold); color: var(--challenge-dark-gold); padding-bottom: 8px; margin-bottom: 15px; }
        .challenge-item { background-color: #fff; border: 1px solid var(--border-color); border-left: 5px solid var(--challenge-dark-gold); border-radius: 5px; padding: 10px; margin-bottom: 10px; transition: background-color: 0.3s, border-color: 0.3s; }
        .challenge-item.completed { border-left-color: var(--income-color) !important; background-color: #e8f8ef !important; }
        #review-rewards-list .challenge-item.completed { background-color: #e8f8ef; border-left-color: var(--income-color); }
        #review-rewards-list .challenge-item.completed h4, #earned-trophies-list .challenge-item.completed h4 { color: var(--challenge-text); }
        .challenge-item.failed { border-left-color: var(--expense-color) !important; background-color: #fbe9e7 !important; }
        #active-challenges-list .challenge-item.active-challenge-highlight { background-color: var(--challenge-dark-gold); border-color: var(--challenge-gold); color: white; }
        #active-challenges-list .challenge-item.active-challenge-highlight h4, #active-challenges-list .challenge-item.active-challenge-highlight p, #active-challenges-list .challenge-item.active-challenge-highlight .challenge-item-footer { color: white; }
        .challenge-item h4 { margin: 0 0 5px 0; color: var(--text-color); }
        .challenge-item p { margin: 0 0 10px 0; font-size: 0.9em; }
        .challenge-item-footer { display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; color: #555; }
        #prompt-content select, #prompt-content input { width: 100%; padding: 10px; margin-top: 10px; border: 1px solid var(--border-color); border-radius: 5px; }
        .btn-gold { background-color: var(--challenge-dark-gold); }
        .btn-gold:hover { background-color: var(--challenge-gold); color: var(--challenge-text); }
        .btn-red { background-color: var(--expense-color); }
        .btn-red:hover { background-color: #c0392b; }
        .category-challenge-badge { cursor: pointer; margin-right: 8px; filter: grayscale(0.3); transition: filter 0.2s; }
        .category-challenge-badge:hover { filter: grayscale(0); }
        .modal-overlay.challenge-alert .modal-content { background-color: var(--challenge-bg); color: var(--challenge-text); border: 2px solid var(--challenge-dark-gold); }
        .setting-toggle { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        .setting-toggle label { display: flex; align-items: center; }
        #review-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 15px; }
        .tab-btn { background-color: #f0f0f0; color: var(--text-color); border-bottom: none; border-radius: 5px 5px 0 0; }
        .tab-btn.active { background-color: var(--secondary-bg); border: 1px solid var(--border-color); border-bottom: 1px solid var(--secondary-bg); margin-bottom: -1px; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Tooltip styles */
        .tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        .info-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #ccc;
            color: white;
            text-align: center;
            font-size: 12px;
            line-height: 16px;
            cursor: help;
            margin-left: 8px;
        }
        .tooltip-text {
            visibility: hidden;
            width: 240px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 140%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85em;
            font-weight: normal;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* --- START: STYLES FOR EDIT/MANAGE MODE --- */
        .budget-category:not(.is-editing) .budget-category-header .delete-btn,
        .budget-category:not(.is-editing) .expense-log .icon-btn {
            display: none;
        }
        .budget-category.is-editing .new-expense-form {
            display: none;
        }
        /* --- END: STYLES FOR EDIT/MANage-MODE --- */

        /* --- START: TUTORIAL STYLES --- */
        #tutorial-section {
            display: none;
            text-align: left;
            border-top: 1px solid var(--border-color);
            margin-top: 15px;
            padding-top: 15px;
        }
        .tutorial-item {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .tutorial-header {
            background-color: #f7f7f7;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }
        .tutorial-content {
            padding: 15px;
            display: none;
            font-size: 0.95em;
            line-height: 1.5;
        }
        .tutorial-content p {
            margin: 0 0 10px 0;
        }
        .tutorial-content p:last-child {
            margin-bottom: 0;
        }
        .tutorial-item.active .tutorial-content {
            display: block;
        }
        .tutorial-item.active .tutorial-header .toggle-icon {
            transform: rotate(180deg);
        }
        /* --- END: TUTORIAL STYLES --- */
        
        /* --- START: NEW FEATURE STYLES --- */
        .last-month-spending {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed var(--border-color);
            font-style: italic;
        }
        .rollover-item {
            background-color: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .rollover-item h4 {
            margin: 0 0 10px 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        .rollover-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            font-size: 0.9em;
            text-align: center;
            margin-bottom: 10px;
        }
        .rollover-details span {
            display: block;
        }
        .rollover-details strong {
            font-size: 1.1em;
        }
        /* --- END: NEW FEATURE STYLES --- */

        /* --- START: QUICK ADD STYLES --- */
        .quick-add-category-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }
        .quick-cat-btn {
            padding: 15px 10px;
            background-color: var(--secondary-bg);
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1em;
        }
        .quick-cat-btn:hover, .quick-cat-btn:active {
            background-color: var(--accent-color);
            color: white;
        }
        .quick-step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 8px;
        }
        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ddd;
        }
        .step-dot.active {
            background-color: var(--accent-color);
        }
        #quick-add-amount-display {
            font-size: 2em;
            font-weight: bold;
            color: var(--expense-color);
            margin-bottom: 15px;
        }
        /* Make the primary quick-add expense button more prominent (gold theme) */
        #quick-add-expense-btn {
            width: 100%;
            padding: 14px 18px;
            font-size: 1.05em;
            font-weight: 700;
            color: var(--challenge-text);
            background: linear-gradient(135deg, var(--challenge-dark-gold), var(--challenge-gold));
            border: none;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(212,175,55,0.18);
            cursor: pointer;
            transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
            margin-bottom: 20px;
        }
        #quick-add-expense-btn:hover { transform: translateY(-3px); box-shadow: 0 14px 28px rgba(212,175,55,0.22); }
        #quick-add-expense-btn:active { transform: translateY(-1px); }
        /* --- END: QUICK ADD STYLES --- */

        @media (max-width: 600px) { 
            .chart-container { grid-template-columns: 1fr; } 
            /* ensure settings button flows under the month on small screens */
            #manage-accounts-btn { position: static; margin-top: 8px; }
            #app-logo { top: 15px; left: 15px; }
            .rollover-details { grid-template-columns: 1fr; text-align: left; }
        }
    </style>
</head>
<body>
    <div class="container app-content">
        <header>
            <img src="bb%20logo.png" alt="Budgety Buddy Logo" id="app-title-logo">
            <div>
                <h2 id="current-account-name"></h2>
            </div>
            <p id="current-month"></p>
            <div>
                <button id="manage-accounts-btn" class="control-btn">Settings & Share</button>
            </div>
        </header>

        <button id="review-btn" style="width: 100%; margin-bottom: 10px;">üìä Monthly Review</button>
        <button id="challenge-center-btn" style="width: 100%; margin-bottom: 20px;">
            üèÜ Challenge Center
            <br>
            <span id="active-challenge-counter" style="display: none; font-size: 0.8em; font-weight: normal;"></span>
        </button>
        <button id="no-spend-today-btn" style="width: 100%; margin-bottom: 20px; display: none; background-color: var(--income-color);">‚úÖ I Didn't Spend Today!</button>
        
        <div class="section" id="income-expenses-section">
            <div class="section-header"><h3>üí∞ Income & Fixed Expenses</h3><div class="toggle-icon">‚ñº</div></div>
            <div class="section-summary-view"><span>Total Income: <strong id="summary-total-income">$0.00</strong></span><span>Total Expenses: <strong id="summary-total-expenses">$0.00</strong></span></div>
            <div class="section-content">
                <h4>Income</h4><div id="income-list"></div><div class="input-group"><input type="text" id="income-name-input" placeholder="e.g., Paycheck"><input type="number" id="income-amount-input" placeholder="Amount" min="0" step="0.01"><button id="add-income-btn" class="add-btn">+</button></div><hr>
                <h4>Monthly Fixed Expenses</h4><div id="expense-list"></div><div class="input-group"><input type="text" id="expense-name-input" placeholder="e.g., Rent"><input type="number" id="expense-amount-input" placeholder="Amount" min="0" step="0.01"><button id="add-expense-btn" class="add-btn">+</button></div>
            </div>
        </div>

        <button id="quick-add-expense-btn">Ôºã Quick Add Expense</button>

        <div class="summary-display budget-section-summary">
            <h2>Remaining to Spend</h2>
            <p id="remaining-to-spend">$0.00</p>
            <p class="amount-spent">Amount spent: <span id="amount-spent-value">$0.00</span></p>
        </div>
        
        <div class="section" id="budget-spending-section">
            <div class="section-header">
                <h3>üõí Budgeted Spending</h3>
                <div class="category-controls"><button id="reorder-toggle-btn" class="control-btn">Reorder</button><button id="expand-all-btn" class="control-btn">Expand All</button><button id="collapse-all-btn" class="control-btn">Collapse All</button></div>
            </div>
            <div class="section-content" id="budget-categories-list"></div>
            <button class="add-category-btn" id="add-category-btn">+ New Budget Category</button>
            <div class="hidden-form" id="new-category-form" style="display: none; padding: 10px; background-color: #eaf2fa; border-radius: 5px;">
                <div class="input-group" id="standard-input-group">
                    <input type="text" id="category-name-input" placeholder="Category Name">
                    <input type="number" id="category-limit-input" placeholder="Budget Limit" min="0" step="0.01">
                </div>
                <div class="setting-toggle" style="padding: 5px 0;">
                    <label for="sinking-fund-toggle">Make this a Sinking Fund?
                        <span class="tooltip-container">
                            <span class="info-icon">?</span>
                            <span class="tooltip-text">A sinking fund lets you save for a specific large expense over time by setting aside money each month. The monthly amount is calculated automatically. Unspent funds automatically roll over.</span>
                        </span>
                    </label>
                    <input type="checkbox" id="sinking-fund-toggle">
                </div>
                <div id="sinking-fund-inputs" style="display: none;">
                    <div class="input-group">
                        <input type="number" id="sinking-fund-goal-input" placeholder="Total Goal Amount" min="0" step="0.01">
                        <input type="number" id="sinking-fund-months-input" placeholder="# of Months" min="1" step="1">
                    </div>
                </div>
                 <button id="save-category-btn" style="width: 100%; margin-top: 10px;">Save Category</button>
            </div>
        </div>

        <div class="section" id="allocation-section" style="padding: 15px; border-style: dashed;">
            <div class="section-header" style="padding-bottom:10px; border-bottom: 1px solid var(--border-color); margin-bottom:10px;">
                <h3>üìä Allocation Center</h3><div class="toggle-icon">‚ñº</div>
            </div>
            <div class="section-content">
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 8px;"><span><strong>Available to Allocate:</strong> <span id="total-to-budget">$0.00</span></span></div>
                <div style="font-size: 0.9em; margin-bottom: 8px; color: #555;">- Allocated to Budgets: <span id="allocated-in-budgets">$0.00</span></div>
                <div style="font-size: 0.9em; margin-bottom: 8px; color: #555;">- Allocated to Savings: <span id="allocated-to-savings">$0.00</span></div>
                <div class="progress-bar" style="height: 12px; margin-top: 5px;">
                    <div id="allocation-progress-bar" class="progress-bar-inner"></div>
                    <div id="allocation-overspent-bar" class="progress-bar-inner progress-bar-overspent"></div>
                </div>
                <div style="text-align: right; font-weight: bold; margin-top: 8px;">Remaining to Allocate: <span id="remaining-to-allocate">$0.00</span></div>
            </div>
        </div>
        
        <div class="section" id="savings-section">
             <div class="section-header"><h3>üè¶ Savings Goals</h3></div>
            <div class="section-content" id="savings-goals-list"></div>
            <button class="add-category-btn" id="add-savings-goal-btn">+ New Savings Goal</button>
            <div class="hidden-form" id="new-savings-goal-form" style="display: none;"><div class="input-group"><input type="text" id="savings-goal-name-input" placeholder="Goal Name (e.g., Vacation)"><input type="number" id="savings-goal-amount-input" placeholder="Goal Amount" min="0" step="0.01"><button id="save-savings-goal-btn">Save Goal</button></div></div>
        </div>
    </div>

    <div class="modal-overlay" id="onboarding-modal"><div class="modal-content"><div class="modal-header"><h2>Welcome to Budgety Buddy</h2></div><p>Create a new budget to share, or join one using an ID from a friend.</p><button id="create-new-budget-btn" style="width: 100%; margin-bottom: 15px;">Create a New Shared Budget</button><hr><p style="margin-top: 15px;"><strong>Or Join Existing Budget</strong></p><div class="input-group"><input type="text" id="join-budget-id-input" placeholder="Enter Sharable ID"><button id="join-budget-btn">Join</button></div></div></div>
    <div class="modal-overlay" id="review-modal"><div class="modal-content"><div class="modal-header"><h2>Monthly Review</h2><button class="close-btn" id="close-review-modal-btn">&times;</button></div>
        <div id="review-content">
            <div id="review-tabs">
                <button class="tab-btn active" data-tab="single-month-view">Single Month</button>
                <button class="tab-btn" data-tab="compare-months-view">Compare Months</button>
            </div>
            
            <div id="single-month-view" class="tab-content active">
                <div id="review-controls" style="width: 100%;"><label for="month-select">Select Month:</label><select id="month-select" style="padding: 8px; width: 100%;"></select></div>
                <div id="no-history-msg" style="display: none; text-align: center; margin-top: 20px;"><p>No historical data for this budget yet.</p><button id="no-history-close-btn" style="margin-top: 15px;">Go Back</button></div>
                <div class="chart-container" id="charts-area"><div><h3>Cash Flow</h3><canvas id="cashflow-chart"></canvas></div><div><h3>Spending Breakdown</h3><canvas id="spending-chart"></canvas></div></div>
                <div class="section" id="review-rewards-section" style="margin-top: 20px; display: none;"><h3>üèÜ Monthly Achievements</h3><div id="review-rewards-list"></div></div>
                <div class="section" id="review-expense-log-section" style="margin-top: 20px; display: none;"><h3>üßæ Detailed Expense Log</h3><div id="review-expense-log-list" style="max-height: 200px; overflow-y: auto; font-size: 0.9em;"></div></div>
            </div>

            <div id="compare-months-view" class="tab-content">
                <div id="comparison-charts-area"></div>
                 <div id="no-comparison-msg" style="display: none; text-align: center; margin-top: 20px;"><p>You need at least two months of history to make a comparison.</p></div>
            </div>
        </div>
    </div></div>
    <div class="modal-overlay" id="accounts-modal"><div class="modal-content"><div class="modal-header"><h2>Budget Settings & Sharing</h2><button class="close-btn" id="close-accounts-modal-btn">&times;</button></div><div id="accounts-content"><h3>Edit Budget Name</h3><div class="input-group"><input type="text" id="edit-account-name-input" placeholder="Budget Name"><button id="save-account-name-btn">Save</button></div><hr><h3>Your Sharable Budget ID</h3><p style="font-size: 0.9em; color: #555;">Give this ID to others so they can join and edit this budget in real-time.</p><div class="input-group"><input type="text" id="sharable-id-display" readonly style="background-color: #f0f0f0; font-weight: bold;"><button id="copy-id-btn">Copy</button></div><hr><h3>Features</h3>
        <div class="setting-toggle">
            <label for="toggle-challenges">Enable Challenge Center
                <span class="tooltip-container">
                    <span class="info-icon">?</span>
                    <span class="tooltip-text">The Challenge Center adds optional monthly goals, like staying under a certain budget or saving a specific amount, to help you build good financial habits.</span>
                </span>
            </label>
            <input type="checkbox" id="toggle-challenges">
        </div>
        <hr>
        <button id="show-tutorial-btn" style="width: 100%; margin-bottom: 15px; background-color: #e9e9e9; color: var(--text-color);">üìñ App Tutorial</button>
        <div id="tutorial-section">
            <div class="tutorial-item">
                <div class="tutorial-header"><span>‚≠ê The Big Idea: Zero-Based Budgeting</span> <span class="toggle-icon">‚ñº</span></div>
                <div class="tutorial-content">
                    <p>The goal of this app is to help you create a **zero-based budget**. This simply means you give every single dollar a "job" to do.</p>
                    <p>Your main objective is to make the **"Remaining to Allocate"** number in the Allocation Center equal **$0.00**. This ensures that all your income is intentionally assigned to a bill, a spending category, or a savings goal, giving you total control over your money.</p>
                </div>
            </div>
            <div class="tutorial-item">
                <div class="tutorial-header"><span>üöÄ Getting Started in 3 Steps</span> <span class="toggle-icon">‚ñº</span></div>
                <div class="tutorial-content">
                    <p><b>1. Add Income & Bills:</b> In the "Income & Fixed Expenses" section, enter your monthly paychecks and all recurring bills like rent, utilities, and subscriptions. This calculates your starting money, shown as "Available to Allocate".</p>
                    <p><b>2. Create Spending Budgets:</b> In "Budgeted Spending," create categories for your variable spending (e.g., Groceries, Gas, Fun Money) and set a spending limit for each.</p>
                    <p><b>3. Plan Your Savings:</b> Finally, go to "Savings Goals" and create goals for the rest of your money. Assigning your remaining funds here is how you get the "Remaining to Allocate" down to zero!</p>
                </div>
            </div>
            <div class="tutorial-item">
                <div class="tutorial-header"><span>üí∞ Understanding "Remaining to Spend"</span> <span class="toggle-icon">‚ñº</span></div>
                <div class="tutorial-content">
                    <p>This is the most important number for your daily life! It shows you how much money you have left to spend **only within your "Budgeted Spending" categories**.</p>
                    <p>It's your guilt-free spending money. It is completely separate from your savings goals, so you always know exactly what you can spend without affecting your ability to save.</p>
                </div>
            </div>
            <div class="tutorial-item">
                <div class="tutorial-header"><span>üè¶ What's a "Sinking Fund"?</span> <span class="toggle-icon">‚ñº</span></div>
                <div class="tutorial-content">
                    <p>A Sinking Fund is a smart way to save for a **large, specific future expense** (like new tires, a vacation, or holiday gifts). </p>
                    <p>When you create one, you set a total goal and a number of months. The app automatically calculates how much you need to budget for it each month. It's a powerful tool to plan ahead and avoid debt.</p>
                </div>
            </div>
        </div>
        <button id="leave-budget-btn" style="width:100%; background-color: var(--expense-color);">Leave Budget</button></div></div></div>
    <div class="modal-overlay" id="confirm-modal"><div class="modal-content"><p id="confirm-msg"></p><div class="confirm-actions"><button id="confirm-cancel-btn" style="background-color: #777;">Cancel</button><button id="confirm-ok-btn">Confirm</button></div></div></div>
    
    <div class="modal-overlay" id="rollover-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="rollover-title">Month Rollover Summary</h2>
                <button class="close-btn" id="close-rollover-modal-btn">&times;</button>
            </div>
            <p style="font-size: 0.9em; color: #555; margin-top: -10px; margin-bottom: 20px;">
                Here's a summary of your unspent funds from last month. You can transfer these amounts to your savings goals as a bonus!
            </p>
            <div id="rollover-summary-list"></div>
            <div class="confirm-actions">
                <button id="rollover-skip-btn" style="background-color: #777;">Skip for Now</button>
                <button id="rollover-confirm-btn">Confirm Transfers</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="challenge-modal">
        <div class="modal-content">
            <div class="modal-header"><h2>üèÜ Challenge Center</h2><button class="close-btn" id="close-challenge-modal-btn">&times;</button></div>
            <div id="challenge-content">
                <div class="challenge-section">
                    <h3>This Month's Challenges</h3>
                    <div id="active-challenges-list"></div>
                </div>
                <hr style="margin: 25px 0;">
                <div class="challenge-section">
                    <h3>Available Challenges</h3>
                    <div id="available-challenges-list"></div>
                </div>
                <hr style="margin: 25px 0;">
                <div class="challenge-section" id="earned-trophies-section">
                    <h3>üèÜ Earned Trophies</h3>
                    <div id="earned-trophies-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="prompt-modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="prompt-title"></h2></div>
            <div id="prompt-content" style="text-align: left;"></div>
            <div class="confirm-actions">
                <button id="prompt-cancel-btn" style="background-color: #777;">Cancel</button>
                <button id="prompt-ok-btn">OK</button>
            </div>
        </div>
    </div>

    <!-- NEW QUICK ADD WIZARD MODAL -->
    <div class="modal-overlay" id="quick-add-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="quick-add-title">Quick Add</h2>
                <button class="close-btn" id="close-quick-add-btn">&times;</button>
            </div>
            <div class="quick-step-indicator">
                <div class="step-dot active" id="step-dot-1"></div>
                <div class="step-dot" id="step-dot-2"></div>
                <div class="step-dot" id="step-dot-3"></div>
            </div>
            <div id="quick-add-step-content">
                <!-- Dynamic Content -->
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove, update, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAyPf2h3NhhHa1HqyHGkp7kvID72iVM0q8", authDomain: "simple-budget-43c48.firebaseapp.com", databaseURL: "https://simple-budget-43c48-default-rtdb.firebaseio.com", projectId: "simple-budget-43c48", storageBucket: "simple-budget-43c48.firebasestorage.app", messagingSenderId: "227409147398", appId: "1:227409147398:web:5cc2085c35021220daf587", measurementId: "G-MNJNXG67ST" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let state = {}; 
        let currentBudgetId = null;
        let dbRef = null;
        let history = [];
        let cashflowChartInstance, spendingChartInstance, comparisonCashflowChart, comparisonSpendingChart;
        let isFirstLoad = true; 

        // --- QUICK ADD STATE ---
        let quickAddState = {
            step: 1,
            amount: 0,
            categoryKey: null,
            note: ''
        };

        const selectors = {
            appContent: document.querySelector('.app-content'),
            remainingToSpend: document.getElementById('remaining-to-spend'), currentMonth: document.getElementById('current-month'), 
            incomeList: document.getElementById('income-list'), incomeNameInput: document.getElementById('income-name-input'), incomeAmountInput: document.getElementById('income-amount-input'), addIncomeBtn: document.getElementById('add-income-btn'), 
            expenseList: document.getElementById('expense-list'), expenseNameInput: document.getElementById('expense-name-input'), expenseAmountInput: document.getElementById('expense-amount-input'), addExpenseBtn: document.getElementById('add-expense-btn'), 
            budgetCategoriesList: document.getElementById('budget-categories-list'), addCategoryBtn: document.getElementById('add-category-btn'), newCategoryForm: document.getElementById('new-category-form'), categoryNameInput: document.getElementById('category-name-input'), categoryLimitInput: document.getElementById('category-limit-input'), saveCategoryBtn: document.getElementById('save-category-btn'), 
            
            sinkingFundToggle: document.getElementById('sinking-fund-toggle'),
            sinkingFundInputs: document.getElementById('sinking-fund-inputs'),
            sinkingFundGoalInput: document.getElementById('sinking-fund-goal-input'),
            sinkingFundMonthsInput: document.getElementById('sinking-fund-months-input'),

            savingsGoalsList: document.getElementById('savings-goals-list'), addSavingsGoalBtn: document.getElementById('add-savings-goal-btn'), newSavingsGoalForm: document.getElementById('new-savings-goal-form'), savingsGoalNameInput: document.getElementById('savings-goal-name-input'), savingsGoalAmountInput: document.getElementById('savings-goal-amount-input'), saveSavingsGoalBtn: document.getElementById('save-savings-goal-btn'),
            incomeExpensesSection: document.getElementById('income-expenses-section'),
            allocationSection: document.getElementById('allocation-section'),
            summaryTotalIncome: document.getElementById('summary-total-income'), summaryTotalExpenses: document.getElementById('summary-total-expenses'),
            expandAllBtn: document.getElementById('expand-all-btn'), collapseAllBtn: document.getElementById('collapse-all-btn'),
            reorderToggleBtn: document.getElementById('reorder-toggle-btn'),
            reviewBtn: document.getElementById('review-btn'), reviewModal: document.getElementById('review-modal'), closeReviewModalBtn: document.getElementById('close-review-modal-btn'),
            monthSelect: document.getElementById('month-select'), chartsArea: document.getElementById('charts-area'), noHistoryMsg: document.getElementById('no-history-msg'),
            reviewControls: document.getElementById('review-controls'), noHistoryCloseBtn: document.getElementById('no-history-close-btn'),
            currentAccountName: document.getElementById('current-account-name'), manageAccountsBtn: document.getElementById('manage-accounts-btn'),
            accountsModal: document.getElementById('accounts-modal'), closeAccountsModalBtn: document.getElementById('close-accounts-modal-btn'),
            sharableIdDisplay: document.getElementById('sharable-id-display'), copyIdBtn: document.getElementById('copy-id-btn'), leaveBudgetBtn: document.getElementById('leave-budget-btn'),
            editAccountNameInput: document.getElementById('edit-account-name-input'), saveAccountNameBtn: document.getElementById('save-account-name-btn'),
            confirmModal: document.getElementById('confirm-modal'), confirmMsg: document.getElementById('confirm-msg'), confirmOkBtn: document.getElementById('confirm-ok-btn'), confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
            onboardingModal: document.getElementById('onboarding-modal'), createNewBudgetBtn: document.getElementById('create-new-budget-btn'), joinBudgetBtn: document.getElementById('join-budget-btn'), joinBudgetIdInput: document.getElementById('join-budget-id-input'),
            totalToBudget: document.getElementById('total-to-budget'), allocatedInBudgets: document.getElementById('allocated-in-budgets'), allocatedToSavings: document.getElementById('allocated-to-savings'), remainingToAllocate: document.getElementById('remaining-to-allocate'), 
            allocationProgressBar: document.getElementById('allocation-progress-bar'),
            allocationOverspentBar: document.getElementById('allocation-overspent-bar'),
            challengeCenterBtn: document.getElementById('challenge-center-btn'),
            challengeModal: document.getElementById('challenge-modal'),
            closeChallengeModalBtn: document.getElementById('close-challenge-modal-btn'),
            activeChallengesList: document.getElementById('active-challenges-list'),
            availableChallengesList: document.getElementById('available-challenges-list'),
            challengeBtnCounter: document.getElementById('active-challenge-counter'),
            promptModal: document.getElementById('prompt-modal'),
            promptTitle: document.getElementById('prompt-title'),
            promptContent: document.getElementById('prompt-content'),
            promptOkBtn: document.getElementById('prompt-ok-btn'),
            promptCancelBtn: document.getElementById('prompt-cancel-btn'),
            reviewRewardsSection: document.getElementById('review-rewards-section'),
            reviewRewardsList: document.getElementById('review-rewards-list'),
            earnedTrophiesList: document.getElementById('earned-trophies-list'),
            toggleChallenges: document.getElementById('toggle-challenges'),
            reviewTabs: document.getElementById('review-tabs'),
            singleMonthView: document.getElementById('single-month-view'),
            compareMonthsView: document.getElementById('compare-months-view'),
            noComparisonMsg: document.getElementById('no-comparison-msg'),
            comparisonChartsArea: document.getElementById('comparison-charts-area'),
            reviewExpenseLogSection: document.getElementById('review-expense-log-section'),
            reviewExpenseLogList: document.getElementById('review-expense-log-list'),
            noSpendTodayBtn: document.getElementById('no-spend-today-btn'),
            showTutorialBtn: document.getElementById('show-tutorial-btn'),
            tutorialSection: document.getElementById('tutorial-section'),
            quickAddExpenseBtn: document.getElementById('quick-add-expense-btn'),
            rolloverModal: document.getElementById('rollover-modal'),
            closeRolloverModalBtn: document.getElementById('close-rollover-modal-btn'),
            rolloverTitle: document.getElementById('rollover-title'),
            rolloverSummaryList: document.getElementById('rollover-summary-list'),
            rolloverConfirmBtn: document.getElementById('rollover-confirm-btn'),
            rolloverSkipBtn: document.getElementById('rollover-skip-btn'),
            // Quick Add Selectors
            quickAddModal: document.getElementById('quick-add-modal'),
            closeQuickAddBtn: document.getElementById('close-quick-add-btn'),
            quickAddTitle: document.getElementById('quick-add-title'),
            quickAddStepContent: document.getElementById('quick-add-step-content'),
            amountSpentValue: document.getElementById('amount-spent-value'),
        };

        const currencyFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
        
        const CHALLENGE_DEFINITIONS = {
            stayUnderBudget: {
                title: "Stay Under Budget",
                description: "Pick a spending category and set a custom spending limit for this month.",
                requires: 'budgetCategory',
                prompt: { amount: "Enter your target spending limit for this category:" },
                badge: 'üí∞'
            },
            noSpend: {
                title: "No-Spend Challenge",
                description: "Pick a spending category and try not to spend any money in it for a set number of days.",
                requires: 'budgetCategory',
                prompt: { days: "For how many days do you want to attempt this challenge?" },
                badge: 'üö´'
            },
            goalBooster: {
                title: "Goal Booster",
                description: "Pick a savings goal and challenge yourself to contribute a specific amount to it.",
                requires: 'savingsGoal',
                prompt: { amount: "What is your contribution goal?" },
                badge: 'üöÄ'
            },
            expenseLogger: {
                title: "Expense Logger",
                description: "Build a habit by logging at least one expense every day for a week.",
                requires: 'none',
                config: { days: 7 },
                badge: '‚úçÔ∏è'
            }
        };

        // --- START: NEW HELPER FUNCTIONS ---
        function getLocalDateString() {
            const date = new Date();
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatYearMonth(ymString) {
            if (!ymString) return "Invalid Date";
            if (ymString.includes(' ')) {
                if (!isNaN(new Date(ymString).getTime())) {
                    return ymString;
                }
            }
            if (ymString.length === 7 && ymString.includes('-')) {
                const [year, month] = ymString.split('-');
                const date = new Date(year, month - 1); 
                if (!isNaN(date.getTime())) {
                    return date.toLocaleString('default', { month: 'long', year: 'numeric' });
                }
            }
            return "Invalid Date"; 
        }

        function getCurrentYearMonth() {
            return new Date().toISOString().slice(0, 7); 
        }

        function toInputDate(dateStr) {
            if (!dateStr) return new Date().toISOString().split('T')[0];
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        const [month, day, year] = parts;
                        const formattedDate = new Date(year, month - 1, day);
                        return formattedDate.toISOString().split('T')[0];
                    }
                    return new Date().toISOString().split('T')[0];
                }
                return date.toISOString().split('T')[0];
            } catch (e) {
                return new Date().toISOString().split('T')[0];
            }
        }
        
        function createNewBudget() { 
            return { 
                accountName: 'My Shared Budget', 
                income: {}, 
                monthlyExpenses: {}, 
                budgetedItems: {}, 
                monthYear: getCurrentYearMonth(),
                incomeSectionCollapsed: true, 
                allocationSectionCollapsed: true, 
                history: {}, 
                activeChallenges: {}, 
                earnedTrophies: {}, 
                challengesEnabled: true, 
                features: { rolloverControlEnabled: false } 
            }; 
        }

        function startNewBudget() { const newBudgetRef = push(ref(db, 'budgets')); const newBudgetId = newBudgetRef.key; set(newBudgetRef, createNewBudget()); connectToBudget(newBudgetId); }
        async function joinBudget() { const budgetId = selectors.joinBudgetIdInput.value.trim(); if (!budgetId) { alert('Please enter a budget ID.'); return; } const budgetRef = ref(db, `budgets/${budgetId}`); const snapshot = await get(budgetRef); if (snapshot.exists()) { connectToBudget(budgetId); } else { alert('Budget ID not found. Please check the ID and try again.'); } }
        
        function connectToBudget(budgetId) {
            currentBudgetId = budgetId;
            dbRef = ref(db, `budgets/${currentBudgetId}`);
            isFirstLoad = true; 

            onValue(dbRef, async (snapshot) => { 
                const data = snapshot.val(); 
                if (data) { 
                    const oldState = { ...state };
                    state = data; 
                    
                    if (isFirstLoad && state.monthYear && state.monthYear.includes(' ')) {
                        const updates = {};
                        let newMonthYear;
                        try {
                            const parts = state.monthYear.split(' ');
                            const monthName = parts[0];
                            const year = parts[1];
                            const monthIndex = new Date(Date.parse(monthName +" 1, 2012")).getMonth();
                            const monthNumber = (monthIndex + 1).toString().padStart(2, '0');
                            newMonthYear = `${year}-${monthNumber}`;
                            updates['/monthYear'] = newMonthYear;
                        } catch (e) {
                            updates['/monthYear'] = getCurrentYearMonth();
                        }
                        if(state.history) {
                            Object.entries(state.history).forEach(([key, monthData]) => {
                                if(monthData.monthYear && monthData.monthYear.includes(' ')) {
                                    try {
                                        const parts = monthData.monthYear.split(' ');
                                        const monthName = parts[0];
                                        const year = parts[1];
                                        const monthIndex = new Date(Date.parse(monthName +" 1, 2012")).getMonth();
                                        const monthNumber = (monthIndex + 1).toString().padStart(2, '0');
                                        updates[`/history/${key}/monthYear`] = `${year}-${monthNumber}`;
                                    } catch(e) { }
                                }
                            });
                        }
                        update(dbRef, updates);
                        return;
                    }
                    
                    const monthChanged = await checkForNewMonth(oldState);
                    if (monthChanged) return;

                    if (isFirstLoad) {
                        isFirstLoad = false; 
                        const updates = {};
                        let needsUpdate = false;
                        if (state.incomeSectionCollapsed !== true) { updates['/incomeSectionCollapsed'] = true; needsUpdate = true; }
                        if (state.allocationSectionCollapsed !== true) { updates['/allocationSectionCollapsed'] = true; needsUpdate = true; }
                        if (state.budgetedItems) {
                            for (const key in state.budgetedItems) {
                                if (state.budgetedItems[key].collapsed !== true) {
                                    updates[`/budgetedItems/${key}/collapsed`] = true;
                                    needsUpdate = true;
                                }
                            }
                        }
                        if (needsUpdate) { update(dbRef, updates); return; }
                    }

                    updateDailyChallenges();

                    history = state.history ? Object.values(state.history).sort((a,b) => {
                        const dateA = a.monthYear.includes(' ') ? new Date(a.monthYear).toISOString().slice(0, 7) : a.monthYear;
                        const dateB = b.monthYear.includes(' ') ? new Date(b.monthYear).toISOString().slice(0, 7) : b.monthYear;
                        return dateB.localeCompare(dateA);
                    }) : [];

                    render(); 
                    selectors.onboardingModal.style.display = 'none'; 
                    selectors.appContent.style.display = 'block'; 
                } 
            });
            localStorage.setItem('lastBudgetId', budgetId);
        }
        
        async function checkForNewMonth(oldState) {
            const currentMonthYear = getCurrentYearMonth();
            if (state.monthYear && currentMonthYear > state.monthYear) {
                const previousMonthName = formatYearMonth(state.monthYear);
                const evaluatedChallenges = { ...(state.activeChallenges || {}) };
                const newlyCompletedKeysForTrophy = [];

                Object.entries(evaluatedChallenges).forEach(([key, challenge]) => {
                    if (challenge.status === 'active') {
                        let isCompleted = false;
                        if (challenge.challengeId === 'stayUnderBudget') {
                            const category = state.budgetedItems?.[challenge.targetCategoryKey];
                            if (category) {
                                const totalSpent = (category.expenses ? Object.values(category.expenses) : []).reduce((sum, exp) => sum + exp.amount, 0);
                                if (totalSpent <= challenge.targetAmount) isCompleted = true;
                            }
                        }
                        if (isCompleted) {
                            evaluatedChallenges[key].status = 'completed';
                            newlyCompletedKeysForTrophy.push(key);
                        } else {
                            evaluatedChallenges[key].status = 'failed';
                        }
                    }
                });

                const stateForHistory = { ...state, activeChallenges: evaluatedChallenges };
                delete stateForHistory.history;
                const newHistoryKey = push(ref(db, `budgets/${currentBudgetId}/history`)).key;
                const newHistory = { ...(state.history || {}), [newHistoryKey]: { ...stateForHistory, monthYear: state.monthYear } };
                const newEarnedTrophies = {};
                newlyCompletedKeysForTrophy.forEach(key => {
                    const challenge = evaluatedChallenges[key];
                    const newTrophyKey = push(ref(db, `budgets/${currentBudgetId}/earnedTrophies`)).key;
                    newEarnedTrophies[newTrophyKey] = { ...challenge, archivedMonth: state.monthYear };
                });

                const rolloverSummaryData = [];
                const newBudgets = state.budgetedItems ? Object.entries(state.budgetedItems).reduce((acc, [key, item]) => {
                    const totalSpent = (item.expenses ? Object.values(item.expenses) : []).reduce((sum, exp) => sum + exp.amount, 0);
                    const unspent = item.limit - totalSpent;
                    if(item.type !== 'savings' && unspent > 0) {
                        rolloverSummaryData.push({ name: item.name, budgeted: item.limit, spent: totalSpent, unspent: unspent });
                    }
                    let newLimit = item.limit; 
                    let rolloverBalance = 0; 
                    if (item.type !== 'savings' && item.rolloverEnabled) {
                        rolloverBalance = unspent;
                    }
                    acc[key] = { ...item, limit: newLimit, rolloverBalance: rolloverBalance, expenses: {}, isEditing: false };
                    return acc;
                }, {}) : {};

                const newMonthData = {
                    ...state,
                    monthYear: currentMonthYear,
                    budgetedItems: newBudgets,
                    activeChallenges: {},
                    earnedTrophies: { ...(state.earnedTrophies || {}), ...newEarnedTrophies },
                    history: newHistory,
                };

                await set(dbRef, newMonthData);
                showRolloverSummary(previousMonthName, rolloverSummaryData);
                if (newlyCompletedKeysForTrophy.length > 0) {
                    setTimeout(() => {
                        const challengeNames = newlyCompletedKeysForTrophy.map(key => `"${CHALLENGE_DEFINITIONS[evaluatedChallenges[key].challengeId].title}"`).join(' and ');
                        showChallengeAlert(`Congratulations! You completed the ${challengeNames} challenge for ${previousMonthName} and earned a new trophy!`);
                    }, 500);
                }
                return true;
            }
            return false;
        }

        function showRolloverSummary(previousMonthName, summaryData) {
            if (summaryData.length === 0) {
                alert(`Welcome to a new month! Your previous month's data for "${state.accountName}" has been archived.`);
                return;
            }
            selectors.rolloverTitle.textContent = `${previousMonthName} Rollover`;
            const savingsGoals = Object.entries(state.budgetedItems || {}).filter(([k,v]) => v.type === 'savings');
            selectors.rolloverSummaryList.innerHTML = summaryData.map(item => {
                const savingsOptions = savingsGoals.length > 0 
                    ? savingsGoals.map(([key, goal]) => `<option value="${key}">${goal.name}</option>`).join('')
                    : '<option value="">No savings goals found</option>';
                return `<div class="rollover-item" data-category-name="${item.name}"><h4>${item.name}</h4><div class="rollover-details"><div><span>Budgeted</span><strong>${currencyFormatter.format(item.budgeted)}</strong></div><div><span>Spent</span><strong>${currencyFormatter.format(item.spent)}</strong></div><div><span>Unspent</span><strong style="color: var(--income-color);">${currencyFormatter.format(item.unspent)}</strong></div></div><label>Transfer to Savings:</label><div class="input-group"><input type="number" class="rollover-amount-input" value="${item.unspent.toFixed(2)}" min="0" max="${item.unspent.toFixed(2)}" step="0.01"><select class="rollover-savings-select" ${savingsGoals.length === 0 ? 'disabled' : ''}>${savingsOptions}</select></div></div>`;
            }).join('');
            selectors.rolloverModal.style.display = 'flex';
        }
        
        function showChallengeAlert(message, type = 'success') {
            selectors.confirmModal.classList.add('challenge-alert');
            selectors.confirmMsg.textContent = message;
            selectors.confirmCancelBtn.style.display = 'none';
            if (type === 'failure') { selectors.confirmOkBtn.textContent = 'Got it!'; } else { selectors.confirmOkBtn.textContent = 'Awesome!'; }
            selectors.confirmModal.style.display = 'flex';
            const onOk = () => {
                selectors.confirmModal.style.display = 'none';
                selectors.confirmModal.classList.remove('challenge-alert');
                selectors.confirmCancelBtn.style.display = 'inline-block';
                selectors.confirmOkBtn.textContent = 'Confirm';
                selectors.confirmOkBtn.removeEventListener('click', onOk);
            };
            selectors.confirmOkBtn.addEventListener('click', onOk);
        }

        function showConfirm(message) { 
            return new Promise(resolve => {
                selectors.confirmOkBtn.textContent = 'Confirm';
                selectors.confirmMsg.textContent = message; 
                selectors.confirmModal.style.display = 'flex'; 
                const onOk = () => { selectors.confirmModal.style.display = 'none'; cleanup(); resolve(true); }; 
                const onCancel = () => { selectors.confirmModal.style.display = 'none'; cleanup(); resolve(false); }; 
                const cleanup = () => { selectors.confirmOkBtn.removeEventListener('click', onOk); selectors.confirmCancelBtn.removeEventListener('click', onCancel); }; 
                selectors.confirmOkBtn.addEventListener('click', onOk); 
                selectors.confirmCancelBtn.addEventListener('click', onCancel); 
            }); 
        }
        
        function showPrompt({ title, inputs }) {
            return new Promise(resolve => {
                selectors.promptTitle.textContent = title;
                selectors.promptContent.innerHTML = '';
                inputs.forEach(input => {
                    let inputHtml = `<label style="display: block; margin-top: 10px; font-weight: 500;">${input.label}</label>`;
                    if (input.type === 'select') {
                        inputHtml += `<select id="${input.id}">` + input.options.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('') + `</select>`;
                    } else {
                        inputHtml += `<input type="${input.type}" id="${input.id}" placeholder="${input.placeholder || ''}" min="1">`;
                    }
                    selectors.promptContent.innerHTML += inputHtml;
                });
                selectors.promptModal.style.display = 'flex';
                
                // Auto-focus for desktop, but mobile might need tap
                setTimeout(() => {
                     const firstInputEl = document.getElementById(inputs[0].id);
                     if (firstInputEl) firstInputEl.focus();
                }, 50);

                const onOk = () => {
                    const results = {};
                    let isValid = true;
                    inputs.forEach(input => {
                        const el = document.getElementById(input.id);
                        if (el.type === 'number' && (el.value === '' || parseFloat(el.value) <= 0)) {
                            isValid = false;
                        }
                        results[input.id] = el.value;
                    });
                    if (!isValid) { alert('Please enter a valid number greater than 0.'); return; }
                    cleanup();
                    resolve(results);
                };
                const onCancel = () => { cleanup(); resolve(null); };
                const cleanup = () => {
                    selectors.promptModal.style.display = 'none';
                    selectors.promptOkBtn.removeEventListener('click', onOk);
                    selectors.promptCancelBtn.removeEventListener('click', onCancel);
                };
                selectors.promptOkBtn.addEventListener('click', onOk);
                selectors.promptCancelBtn.addEventListener('click', onCancel);
            });
        }
        
        const toArray = (obj) => obj ? Object.values(obj) : [];
        const calculateTotalIncome = (data) => toArray(data.income).reduce((sum, item) => sum + item.amount, 0);
        const calculateTotalMonthlyExpenses = (data) => toArray(data.monthlyExpenses).reduce((sum, item) => sum + item.amount, 0);
        const calculateIncomeAfterBills = (data) => calculateTotalIncome(data) - calculateTotalMonthlyExpenses(data);
        const getItemsByType = (data, type) => toArray(data.budgetedItems).filter(item => item.type === type || (type === 'budget' && !item.type));
        
        const calculateTotalAllocatedToBudgets = (data) => getItemsByType(data, 'budget').reduce((sum, cat) => sum + cat.limit, 0);
        const calculateTotalSpendableInBudgets = (data) => getItemsByType(data, 'budget').reduce((sum, cat) => sum + (cat.limit + (cat.rolloverBalance || 0)), 0);

        const calculateTotalAllocatedToSavings = (data) => getItemsByType(data, 'savings').reduce((sum, cat) => sum + cat.limit, 0);
        const calculateTotalBudgetedSpending = (data) => getItemsByType(data, 'budget').flatMap(cat => toArray(cat.expenses)).reduce((sum, exp) => sum + exp.amount, 0);
        const calculateTotalContributions = (data) => getItemsByType(data, 'savings').flatMap(cat => toArray(cat.expenses)).reduce((sum, exp) => sum + exp.amount, 0);
        const calculateSpentInCategory = (categoryKey) => toArray(state.budgetedItems?.[categoryKey]?.expenses).reduce((sum, exp) => sum + exp.amount, 0);
        function getColorForPercentage(percent) { percent = Math.max(0, Math.min(100, percent)); const startColor = { r: 46, g: 204, b: 113 }; const midColor = { r: 255, g: 193, b: 7 }; const r = Math.round(startColor.r + (midColor.r - startColor.r) * (1 - percent / 100)); const g = Math.round(startColor.g + (midColor.g - startColor.g) * (1 - percent / 100)); const b = Math.round(startColor.b + (midColor.b - startColor.b) * (1 - percent / 100)); return `rgb(${r}, ${g}, ${b})`; }

        function render() {
            if(!state) return;
            const challengesEnabled = state.challengesEnabled !== false;
            selectors.challengeCenterBtn.style.display = challengesEnabled ? 'block' : 'none';
            let expenseLoggerChallengeActive = false;
            if (state.activeChallenges && challengesEnabled) {
                const todayStr = getLocalDateString();
                for (const key in state.activeChallenges) {
                    const challenge = state.activeChallenges[key];
                    if (challenge.challengeId === 'expenseLogger' && challenge.status === 'active' && challenge.lastLogDate !== todayStr) {
                        expenseLoggerChallengeActive = true;
                        break;
                    }
                }
            }
            selectors.noSpendTodayBtn.style.display = expenseLoggerChallengeActive ? 'block' : 'none';
            const incomeAfterBills = calculateIncomeAfterBills(state);
            const totalSpendable = calculateTotalSpendableInBudgets(state);
            const totalSpending = calculateTotalBudgetedSpending(state);
            selectors.remainingToSpend.textContent = currencyFormatter.format(totalSpendable - totalSpending);
            // show the total amount spent from budgeted categories (logged expenses)
            if (selectors.amountSpentValue) selectors.amountSpentValue.textContent = currencyFormatter.format(totalSpending);
            selectors.summaryTotalIncome.textContent = currencyFormatter.format(calculateTotalIncome(state));
            selectors.summaryTotalExpenses.textContent = currencyFormatter.format(calculateTotalMonthlyExpenses(state));
            const totalAllocatedToBudgets = calculateTotalAllocatedToBudgets(state);
            const totalAllocatedToSavings = calculateTotalAllocatedToSavings(state);
            const remainingToAllocate = incomeAfterBills - totalAllocatedToBudgets - totalAllocatedToSavings;
            let remainingPercent = 0;
            let overspentPercent = 0;
            if (incomeAfterBills > 0) {
                if (remainingToAllocate >= 0) {
                    remainingPercent = (remainingToAllocate / incomeAfterBills) * 100;
                } else {
                    remainingPercent = 0;
                    overspentPercent = (Math.abs(remainingToAllocate) / incomeAfterBills) * 100;
                }
            } else if (remainingToAllocate > 0) {
                remainingPercent = 100;
            }
            selectors.allocationProgressBar.style.width = `${remainingPercent}%`;
            selectors.allocationProgressBar.style.backgroundColor = getColorForPercentage(remainingPercent);
            selectors.allocationOverspentBar.style.width = `${overspentPercent}%`;
            selectors.totalToBudget.textContent = currencyFormatter.format(incomeAfterBills);
            selectors.allocatedInBudgets.textContent = currencyFormatter.format(totalAllocatedToBudgets);
            selectors.allocatedToSavings.textContent = currencyFormatter.format(totalAllocatedToSavings);
            selectors.remainingToAllocate.textContent = currencyFormatter.format(remainingToAllocate);
            if (remainingToAllocate < 0) {
                selectors.remainingToAllocate.style.color = 'var(--expense-color)';
                selectors.allocationSection.style.borderColor = 'var(--expense-color)';
                selectors.allocationSection.style.backgroundColor = '#fbe9e7'; 
            } else if (remainingToAllocate > 0) {
                selectors.remainingToAllocate.style.color = 'var(--income-color)';
                selectors.allocationSection.style.borderColor = 'var(--income-color)';
                selectors.allocationSection.style.backgroundColor = '#e8f8ef'; 
            } else {
                selectors.remainingToAllocate.style.color = 'var(--text-color)';
                selectors.allocationSection.style.borderColor = 'var(--border-color)';
                selectors.allocationSection.style.backgroundColor = 'transparent';
            }
            if (challengesEnabled) {
                const activeChallengeCount = Object.values(state.activeChallenges || {}).filter(c => c.status === 'active').length;
                if (activeChallengeCount > 0) {
                    selectors.challengeBtnCounter.textContent = `${activeChallengeCount} Active`;
                    selectors.challengeBtnCounter.style.display = 'block';
                } else {
                    selectors.challengeBtnCounter.style.display = 'none';
                }
            }
            renderList(state.income, selectors.incomeList, 'income');
            renderList(state.monthlyExpenses, selectors.expenseList, 'expense');
            renderCategorizedItems();
            if (challengesEnabled) {
                renderChallenges();
            }
            if (state.incomeSectionCollapsed) selectors.incomeExpensesSection.classList.add('collapsed'); else selectors.incomeExpensesSection.classList.remove('collapsed');
            if (state.allocationSectionCollapsed) selectors.allocationSection.classList.add('collapsed'); else selectors.allocationSection.classList.remove('collapsed');
            renderHeader();
        }

        function renderList(items, element, type) { element.innerHTML = ''; if (!items) return; Object.entries(items).forEach(([key, item]) => { const itemHtml = item.isEditing ? `<div class="input-group"><input type="text" class="edit-item-name-input" value="${item.name}"><input type="number" class="edit-item-amount-input" value="${item.amount.toFixed(2)}" min="0" step="0.01"><button class="save-item-btn" data-key="${key}" data-type="${type}">Save</button><button class="cancel-item-btn" style="background-color:#777" data-key="${key}" data-type="${type}">Cancel</button></div>` : `<div class="input-group"><input type="text" value="${item.name}" readonly><input type="number" value="${item.amount.toFixed(2)}" readonly><button class="icon-btn edit-btn edit-item-btn" data-key="${key}" data-type="${type}">‚úèÔ∏è</button><button class="icon-btn delete-btn" data-key="${key}" data-type="${type}">‚úñ</button></div>`; element.innerHTML += itemHtml; }); }
        
        function renderCategorizedItems() { 
            selectors.budgetCategoriesList.innerHTML = ''; 
            selectors.savingsGoalsList.innerHTML = ''; 
            if (!state.budgetedItems) return; 
            let challengedCategoryInfo = {};
            if (state.challengesEnabled !== false) {
                Object.values(state.activeChallenges || {}).forEach(c => {
                    if (c.targetCategoryKey && c.status === 'active') {
                        const definition = CHALLENGE_DEFINITIONS[c.challengeId];
                        if(definition) {
                            challengedCategoryInfo[c.targetCategoryKey] = definition.badge;
                        }
                    }
                });
            }
            const updates = {}; 
            let sortedItems = Object.entries(state.budgetedItems).map(([key, cat], index) => { if (cat.order === undefined) { cat.order = index; updates[`/budgetedItems/${key}/order`] = index; } return [key, cat]; }); if (Object.keys(updates).length > 0) { update(dbRef, updates); } sortedItems.sort((a, b) => a[1].order - b[1].order); const isReordering = selectors.budgetCategoriesList.classList.contains('reordering-active'); 
            sortedItems.forEach(([key, item], index) => { 
                const isSinkingFund = item.isSinkingFund === true;
                const sinkingFundIcon = isSinkingFund ? 'üè¶ ' : '';
                const challengeBadge = challengedCategoryInfo[key];
                const challengeBadgeHTML = challengeBadge ? `<span class="category-challenge-badge" title="This category has an active challenge!">${challengeBadge}</span>` : '';
                const isSavings = item.type === 'savings'; 
                const parentList = isSavings ? selectors.savingsGoalsList : selectors.budgetCategoriesList; 
                const itemDiv = document.createElement('div'); 
                itemDiv.className = `budget-category ${item.collapsed ? 'collapsed' : ''} ${item.isEditing ? 'is-editing' : ''}`;
                let editFormHTML = '';
                if (item.isEditing) {
                    if(isSinkingFund) {
                         editFormHTML = `<div class="edit-category-form"><p><strong>Edit Sinking Fund</strong></p><div class="input-group"><input type="text" class="edit-name-input" value="${item.name}"></div><div class="input-group"><input type="number" class="edit-sf-goal-input" value="${item.sinkingFundData.totalGoal}" placeholder="Total Goal" min="0" step="0.01"><input type="number" class="edit-sf-months-input" value="${item.sinkingFundData.totalMonths}" placeholder="# of Months" min="1" step="1"></div><div style="margin-top: 10px; display: flex; gap: 10px;"><button class="save-edit-btn" data-key="${key}">Save</button><button class="cancel-edit-btn" data-key="${key}" style="background-color: #777;">Cancel</button></div></div>`;
                    } else {
                        let rolloverControlHTML = '';
                        if (!isSavings) {
                            rolloverControlHTML = `<div class="setting-toggle" style="padding: 5px 0; font-weight: normal;"><label for="edit-rollover-${key}">Rollover unspent funds<span class="tooltip-container"><span class="info-icon">?</span><span class="tooltip-text">If checked, any money left in this category at the end of the month will be added to next month's budget for this same category.</span></span></label><input type="checkbox" id="edit-rollover-${key}" class="edit-rollover-toggle" ${item.rolloverEnabled ? 'checked' : ''}></div>`;
                        }
                        editFormHTML = `<div class="edit-category-form"><p><strong>Edit ${isSavings ? 'Goal' : 'Category'}</strong></p><div class="input-group"><input type="text" class="edit-name-input" value="${item.name}"><input type="number" class="edit-limit-input" value="${item.limit.toFixed(2)}" min="0" step="0.01"></div>${rolloverControlHTML}<div style="margin-top: 10px; display: flex; gap: 10px;"><button class="save-edit-btn" data-key="${key}">Save</button><button class="cancel-edit-btn" data-key="${key}" style="background-color: #777;">Cancel</button></div></div>`;
                    }
                }
                const totalContributions = toArray(item.expenses).reduce((sum, exp) => sum + exp.amount, 0); 
                let progressPercent, barColor, overspentPercent = 0, summaryText; 
                if (isSavings) { 
                    progressPercent = item.limit > 0 ? Math.min(100, 100 * (totalContributions / item.limit)) : 0; 
                    barColor = 'var(--income-color)'; 
                    summaryText = `${currencyFormatter.format(totalContributions)} saved of ${currencyFormatter.format(item.limit)} goal`; 
                } else { 
                    const rollover = item.rolloverBalance || 0; 
                    const effectiveBudget = item.limit + rollover; 
                    const amountLeft = (effectiveBudget - totalContributions); 
                    summaryText = `${currencyFormatter.format(amountLeft)} left of ${currencyFormatter.format(item.limit)}`;
                    if (rollover !== 0) {
                        const sign = rollover > 0 ? '+' : '';
                        summaryText += ` <span style="font-size: 0.9em; color: ${rollover > 0 ? 'var(--income-color)' : 'var(--expense-color)'};">(${sign}${currencyFormatter.format(rollover)})</span>`;
                    }
                    if (item.limit > 0) { 
                        if (amountLeft > 0) {
                            progressPercent = Math.max(0, 100 * (amountLeft / item.limit));
                            overspentPercent = 0;
                        } else {
                            progressPercent = 0;
                            overspentPercent = Math.min(200, 100 * (Math.max(0, totalContributions - effectiveBudget) / item.limit));
                        }
                    } else { 
                        progressPercent = 0; 
                        if (totalContributions > 0 || amountLeft < 0) { overspentPercent = 100; } else { overspentPercent = 0; }
                    }
                    barColor = getColorForPercentage(progressPercent);
                } 
                let sinkingFundDetailsHTML = '';
                if (isSinkingFund && item.sinkingFundData) {
                    sinkingFundDetailsHTML = `<div class="sinking-fund-details" style="font-size: 0.9em; color: #555; margin-bottom: 10px; padding: 10px; border-bottom: 1px solid var(--border-color); background-color: #f0f8ff; border-radius: 4px;"><strong>Sinking Fund Goal:</strong> ${currencyFormatter.format(item.sinkingFundData.totalGoal)} over ${item.sinkingFundData.totalMonths} months. <br><strong>Monthly Contribution:</strong> ${currencyFormatter.format(item.limit)}</div>`;
                }
                let lastMonthSpendingHTML = '';
                if (!isSavings && history.length > 0) { 
                    const lastMonth = history[0];
                    const categoryInHistory = Object.values(lastMonth.budgetedItems || {}).find(cat => cat.name === item.name);
                    if (categoryInHistory) {
                        const lastMonthTotal = toArray(categoryInHistory.expenses).reduce((sum, exp) => sum + exp.amount, 0);
                        if (lastMonthTotal > 0) {
                            lastMonthSpendingHTML = `<div class="last-month-spending">Last month's spending: ${currencyFormatter.format(lastMonthTotal)}</div>`;
                        }
                    }
                }
                const expenseLogsHTML = item.expenses ? Object.entries(item.expenses).map(([expKey, exp]) => { if (exp.isEditing) { return `<li class="edit-expense-form"><div class="input-group"><input type="number" class="edit-expense-amount-input" value="${exp.amount.toFixed(2)}"><input type="text" class="edit-expense-note-input" placeholder="Note" value="${exp.note || ''}"><input type="date" class="edit-expense-date-input" value="${toInputDate(exp.date)}"></div><div style="margin-top:5px; display:flex; gap:5px;"><button class="save-edit-expense-btn" data-category-key="${key}" data-expense-key="${expKey}">Save</button><button class="cancel-edit-expense-btn" data-category-key="${key}" data-expense-key="${expKey}" style="background-color:#777">Cancel</button></div></li>`; } return `<li><span class="amount">${currencyFormatter.format(exp.amount)}</span><span class="note">${exp.note}</span><span class="date-stamp">${exp.date || ''}</span><div style="display:flex; gap:5px;"><button class="icon-btn edit-btn edit-expense-btn" data-category-key="${key}" data-expense-key="${expKey}">‚úèÔ∏è</button><button class="icon-btn delete-btn delete-expense-btn" data-category-key="${key}" data-expense-key="${expKey}">‚úñ</button></div></li>`; }).join('') : ''; 
                const reorderControlsHTML = isSavings ? '' : `<span class="reorder-controls"><button class="move-btn move-up-btn" data-key="${key}" ${index === 0 ? 'disabled' : ''}>üîº</button><button class="move-btn move-down-btn" data-key="${key}" ${index === sortedItems.length - 1 ? 'disabled' : ''}>üîΩ</button></span>`; 
                itemDiv.innerHTML = `<div class="budget-category-header" data-key="${key}"><span style="display: flex; align-items: center;">${challengeBadgeHTML}${reorderControlsHTML}${sinkingFundIcon}${item.name}</span><div style="display: flex; align-items: center; gap: 5px;"><button class="icon-btn edit-btn" data-key="${key}">‚úèÔ∏è</button><button class="icon-btn delete-btn" data-key="${key}" data-type="category">‚úñ</button><span class="toggle-icon" style="margin-left: 15px;">‚ñº</span></div></div>${editFormHTML}<div class="budget-summary-text">${summaryText}</div><div class="progress-bar"><div class="progress-bar-inner" style="width: ${progressPercent}%; background-color: ${barColor};"></div>${!isSavings ? `<div class="progress-bar-inner progress-bar-overspent" style="width: ${overspentPercent}%;"></div>` : ''}</div><div class="budget-category-content">${sinkingFundDetailsHTML}${lastMonthSpendingHTML}<div class="new-expense-form"><div class="input-group"><input type="number" placeholder="Amount" class="expense-amount-input" min="0" step="0.01"><input type="text" placeholder="Note (optional)" class="expense-note-input"><button class="add-expense-to-category-btn">${isSavings ? 'Add Contribution' : 'Add Expense'}</button></div></div><ul class="expense-log">${expenseLogsHTML}</ul></div>`;
                parentList.appendChild(itemDiv); 
            }); 
        }
        
        // --- START: MODIFIED FUNCTION ---
        function renderHeader() { 
            const accountName = state.accountName || `Shared Budget`; 
            document.title = `Budgety Buddy - ${accountName}`; 
            selectors.currentAccountName.textContent = accountName; 
            selectors.currentMonth.textContent = formatYearMonth(state.monthYear); 
        }
        // --- END: MODIFIED FUNCTION ---

        function createCashflowChart(monthData) { if(cashflowChartInstance) cashflowChartInstance.destroy(); const totalIncome = calculateTotalIncome(monthData); const totalSpending = calculateTotalMonthlyExpenses(monthData) + calculateTotalBudgetedSpending(monthData) + calculateTotalContributions(monthData); const ctx = document.getElementById('cashflow-chart').getContext('2d'); cashflowChartInstance = new Chart(ctx, { type: 'bar', data: { labels: ['Total Income', 'Total Outgoing'], datasets: [{ label: 'Amount', data: [totalIncome, totalSpending], backgroundColor: ['rgba(46, 204, 113, 0.7)', 'rgba(231, 76, 60, 0.7)'], borderColor: ['#2ecc71', '#e74c3c'], borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } }); }
        function createSpendingChart(monthData) { if(spendingChartInstance) spendingChartInstance.destroy(); const categorySpending = getItemsByType(monthData, 'budget').map(cat => ({ name: cat.name, total: toArray(cat.expenses).reduce((sum, exp) => sum + exp.amount, 0) })).filter(c => c.total > 0); const ctx = document.getElementById('spending-chart').getContext('2d'); spendingChartInstance = new Chart(ctx, { type: 'pie', data: { labels: categorySpending.map(c => c.name), datasets: [{ data: categorySpending.map(c => c.total), borderWidth: 1 }] }, options: { plugins: { legend: { position: 'bottom' } } } }); }
        
        // --- START: MODIFIED FUNCTION ---
        function createComparisonCashflowChart(month1, month2) { 
            if(comparisonCashflowChart) comparisonCashflowChart.destroy(); 
            const totalIncome1 = calculateTotalIncome(month1); 
            const totalOutgoing1 = calculateTotalMonthlyExpenses(month1) + calculateTotalBudgetedSpending(month1) + calculateTotalContributions(month1); 
            const totalIncome2 = calculateTotalIncome(month2); 
            const totalOutgoing2 = calculateTotalMonthlyExpenses(month2) + calculateTotalBudgetedSpending(month2) + calculateTotalContributions(month2); 
            const ctx = document.getElementById('comparison-cashflow-chart').getContext('2d'); 
            comparisonCashflowChart = new Chart(ctx, { type: 'bar', data: { labels: ['Total Income', 'Total Outgoing'], datasets: [ 
                { label: formatYearMonth(month1.monthYear), data: [totalIncome1, totalOutgoing1], backgroundColor: 'rgba(74, 144, 226, 0.7)', }, 
                { label: formatYearMonth(month2.monthYear), data: [totalIncome2, totalOutgoing2], backgroundColor: 'rgba(126, 211, 33, 0.7)', } 
            ] } }); 
        }
        function createComparisonSpendingChart(month1, month2) { 
            if(comparisonSpendingChart) comparisonSpendingChart.destroy(); 
            const spending1 = getItemsByType(month1, 'budget').reduce((acc, cat) => { acc[cat.name] = toArray(cat.expenses).reduce((sum, exp) => sum + exp.amount, 0); return acc; }, {}); 
            const spending2 = getItemsByType(month2, 'budget').reduce((acc, cat) => { acc[cat.name] = toArray(cat.expenses).reduce((sum, exp) => sum + exp.amount, 0); return acc; }, {}); 
            const allCategoryNames = [...new Set([...Object.keys(spending1), ...Object.keys(spending2)])]; 
            const data1 = allCategoryNames.map(name => spending1[name] || 0); 
            const data2 = allCategoryNames.map(name => spending2[name] || 0); 
            const ctx = document.getElementById('comparison-spending-chart').getContext('2d'); 
            comparisonSpendingChart = new Chart(ctx, { type: 'bar', data: { labels: allCategoryNames, datasets: [ 
                { label: formatYearMonth(month1.monthYear), data: data1, backgroundColor: 'rgba(74, 144, 226, 0.7)', }, 
                { label: formatYearMonth(month2.monthYear), data: data2, backgroundColor: 'rgba(126, 211, 33, 0.7)', } 
            ] }, options: { indexAxis: 'y' } }); 
        }
        // --- END: MODIFIED FUNCTION ---
        
        function renderChallenges() {
            renderAvailableChallenges();
            renderActiveChallenges();
            renderEarnedTrophies();
        }

        function renderAvailableChallenges() {
            selectors.availableChallengesList.innerHTML = '';
            Object.entries(CHALLENGE_DEFINITIONS).forEach(([id, challenge]) => {
                const item = document.createElement('div');
                item.className = 'challenge-item';
                item.innerHTML = `<h4>${challenge.badge} ${challenge.title}</h4><p>${challenge.description}</p><div class="challenge-item-footer"><span>Ready to try?</span><button class="start-challenge-btn btn-gold" data-challenge-id="${id}">Start</button></div>`;
                selectors.availableChallengesList.appendChild(item);
            });
        }

        function renderActiveChallenges() {
            selectors.activeChallengesList.innerHTML = '';
            const activeChallenges = state.activeChallenges || {};
            if (Object.keys(activeChallenges).length === 0) {
                selectors.activeChallengesList.innerHTML = '<p>You have no active challenges this month.</p>';
                return;
            }
            Object.entries(activeChallenges).forEach(([key, challenge]) => {
                const definition = CHALLENGE_DEFINITIONS[challenge.challengeId];
                if (!definition) { console.warn(`Found an unknown or invalid challenge with ID: "${challenge.challengeId}". Skipping.`); return; }
                let progressText = '';
                switch (challenge.challengeId) {
                    case 'stayUnderBudget': progressText = `${currencyFormatter.format(challenge.currentAmount || 0)} / ${currencyFormatter.format(challenge.targetAmount)} spent`; break;
                    case 'noSpend': progressText = `Current streak: ${challenge.currentStreak || 0} / ${challenge.targetDays} days`; break;
                    case 'goalBooster': progressText = `${currencyFormatter.format(challenge.currentAmount || 0)} / ${currencyFormatter.format(challenge.targetAmount)} saved`; break;
                    case 'expenseLogger': progressText = `Current streak: ${challenge.currentStreak || 0} / ${challenge.targetDays} days`; break;
                }
                const item = document.createElement('div');
                item.className = 'challenge-item';
                if (challenge.status === 'completed') item.classList.add('completed');
                if (challenge.status === 'failed') item.classList.add('failed');
                if (challenge.status === 'active') item.classList.add('active-challenge-highlight');
                item.innerHTML = `<h4>${definition.badge} ${definition.title} ${challenge.targetCategoryName ? `(${challenge.targetCategoryName})` : ''}</h4><p>${definition.description}</p><div class="challenge-item-footer"><span>${progressText}</span><button class="quit-challenge-btn btn-red" data-challenge-key="${key}">Quit</button></div>`;
                if (challenge.status !== 'active') { item.querySelector('.quit-challenge-btn').remove(); }
                selectors.activeChallengesList.appendChild(item);
            });
        }

        function renderEarnedTrophies() {
            selectors.earnedTrophiesList.innerHTML = '';
            const trophies = state.earnedTrophies || {};
            if (Object.keys(trophies).length === 0) { selectors.earnedTrophiesList.innerHTML = '<p>Complete challenges to earn trophies!</p>'; return; }
            let html = '';
            Object.values(trophies).sort((a,b) => new Date(b.startDate) - new Date(a.startDate)).forEach(trophy => {
                const definition = CHALLENGE_DEFINITIONS[trophy.challengeId];
                 html += `<div class="challenge-item completed"><h4>${definition.badge} ${definition.title} ${trophy.targetCategoryName ? `(${trophy.targetCategoryName})` : ''}</h4><p>Completed: ${formatYearMonth(trophy.archivedMonth)}</p></div>`;
            });
            selectors.earnedTrophiesList.innerHTML = html;
        }

        function renderReviewRewards(monthData) {
            const rewardsSection = selectors.reviewRewardsSection;
            const rewardsList = selectors.reviewRewardsList;
            rewardsList.innerHTML = '';
            rewardsSection.style.display = 'block';
            const allTrophiesInHistory = monthData.earnedTrophies || {};
            const trophiesForThisMonth = Object.values(allTrophiesInHistory).filter(trophy => trophy.archivedMonth === monthData.monthYear);
            if (trophiesForThisMonth.length === 0) { rewardsList.innerHTML = '<p>No new trophies were earned this month.</p>'; return; }
            let html = '';
            trophiesForThisMonth.forEach(trophy => {
                const definition = CHALLENGE_DEFINITIONS[trophy.challengeId];
                if (definition) { html += `<div class="challenge-item completed"><h4>${definition.badge} ${definition.title} ${trophy.targetCategoryName ? `(${trophy.targetCategoryName})` : ''}</h4><p>Completed and awarded this month.</p></div>`; }
            });
            rewardsList.innerHTML = html;
        }

        function renderReviewExpenseLog(monthData) {
            const { reviewExpenseLogList, reviewExpenseLogSection } = selectors;
            reviewExpenseLogList.innerHTML = '';
            let allExpenses = [];
            if (monthData.budgetedItems) {
                for (const category of Object.values(monthData.budgetedItems)) {
                    if (category.expenses) {
                        const categoryExpenses = Object.values(category.expenses).map(exp => ({ ...exp, categoryName: category.name }));
                        allExpenses.push(...categoryExpenses);
                    }
                }
            }
            if (allExpenses.length === 0) { reviewExpenseLogSection.style.display = 'none'; return; }
            allExpenses.sort((a, b) => new Date(a.date) - new Date(b.date));
            let html = '';
            allExpenses.forEach(exp => {
                html += `<div style="display: flex; justify-content: space-between; padding: 4px 2px; border-bottom: 1px solid #f0f0f0;"><span style="max-width: 75%; word-break: break-word;"><strong>${currencyFormatter.format(exp.amount)}</strong> - <span style="color: #666; font-style: italic;">${exp.note || 'No note'}</span> <em>(${exp.categoryName})</em></span><span style="color: #888; white-space: nowrap; margin-left: 10px;">${exp.date}</span></div>`;
            });
            reviewExpenseLogList.innerHTML = html;
            reviewExpenseLogSection.style.display = 'block';
        }

        async function startChallenge(challengeId) {
            const definition = CHALLENGE_DEFINITIONS[challengeId];
            const inputs = [];
            if (definition.requires === 'budgetCategory' || definition.requires === 'savingsGoal') {
                const itemType = definition.requires === 'budgetCategory' ? 'budget' : 'savings';
                const categories = Object.entries(state.budgetedItems || {}).filter(([k, v]) => (v.type || 'budget') === itemType);
                if (categories.length === 0) { showChallengeAlert(`You need to create at least one ${itemType === 'budget' ? 'spending category' : 'savings goal'} to start this challenge.`); return; }
                inputs.push({ type: 'select', id: 'category', label: `Select a category for this challenge:`, options: categories.map(([key, cat]) => ({ value: key, text: `${cat.name} (${currencyFormatter.format(cat.limit)})` })) });
            }
            if (definition.prompt?.amount) { inputs.push({ type: 'number', id: 'amount', label: definition.prompt.amount }); }
            if (definition.prompt?.days) { inputs.push({ type: 'number', id: 'days', label: definition.prompt.days }); }
            const result = await showPrompt({ title: definition.title, inputs });
            if (!result) return; 
            let newChallenge = { challengeId, status: 'active', startDate: new Date().toISOString() };
            if (result.category) { newChallenge.targetCategoryKey = result.category; newChallenge.targetCategoryName = state.budgetedItems[result.category].name; }
            if (result.amount) { newChallenge.targetAmount = parseFloat(result.amount); newChallenge.currentAmount = 0; }
            if (result.days) { newChallenge.targetDays = parseInt(result.days); newChallenge.currentStreak = 0; }
            if (challengeId === 'expenseLogger') {
                newChallenge.targetDays = definition.config.days; newChallenge.currentStreak = 0;
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                const year = yesterday.getFullYear(); const month = (yesterday.getMonth() + 1).toString().padStart(2, '0'); const day = yesterday.getDate().toString().padStart(2, '0');
                newChallenge.lastLogDate = `${year}-${month}-${day}`;
            } else if (challengeId === 'noSpend') { newChallenge.lastLogDate = getLocalDateString(); }
            if (challengeId === 'stayUnderBudget') { newChallenge.currentAmount = calculateSpentInCategory(newChallenge.targetCategoryKey); }
            push(ref(db, `budgets/${currentBudgetId}/activeChallenges`), newChallenge);
        }

        function awardTrophy(challengeKey, challengeData) {
            const updates = {};
            const newTrophyRef = push(ref(db, `budgets/${currentBudgetId}/earnedTrophies`));
            updates[`/earnedTrophies/${newTrophyRef.key}`] = { ...challengeData, status: 'completed', archivedMonth: state.monthYear };
            updates[`/activeChallenges/${challengeKey}`] = null;
            update(dbRef, updates);
        }

        function updateDailyChallenges() {
            if (!state.activeChallenges) return;
            const todayStr = getLocalDateString();
            const updates = {};
            let challengesUpdated = false;
            Object.entries(state.activeChallenges).forEach(([key, challenge]) => {
                if (challenge.status !== 'active' || !challenge.lastLogDate) { return; }
                if (challenge.lastLogDate < todayStr) {
                    const lastDate = new Date(challenge.lastLogDate); const todayDate = new Date(todayStr);
                    const timeDiff = todayDate.getTime() - lastDate.getTime(); const dayDiff = Math.round(timeDiff / (1000 * 3600 * 24));
                    if (dayDiff <= 0) return;
                    if (challenge.challengeId === 'noSpend') {
                        const newStreak = (challenge.currentStreak || 0) + dayDiff;
                        if (newStreak >= challenge.targetDays) {
                            const newTrophyKey = push(ref(db, `budgets/${currentBudgetId}/earnedTrophies`)).key;
                            updates[`/earnedTrophies/${newTrophyKey}`] = { ...challenge, status: 'completed', archivedMonth: state.monthYear };
                            updates[`/activeChallenges/${key}`] = null;
                            setTimeout(() => showChallengeAlert(`Congratulations! You completed the "No-Spend Challenge"!`), 200);
                        } else { updates[`/activeChallenges/${key}/currentStreak`] = newStreak; updates[`/activeChallenges/${key}/lastLogDate`] = todayStr; }
                        challengesUpdated = true;
                    }
                    if (challenge.challengeId === 'expenseLogger') {
                        if (dayDiff > 1) { updates[`/activeChallenges/${key}/status`] = 'failed'; challengesUpdated = true; setTimeout(() => showChallengeAlert(`The "Expense Logger" challenge failed because a day was missed.`, 'failure'), 200); }
                    }
                }
            });
            if (challengesUpdated) { update(dbRef, updates); }
        }
        
        function updateChallengeProgress(expenseChange) {
            if (state.challengesEnabled === false) return;
            const activeChallenges = state.activeChallenges || {};
            const updates = {};
            const today = getLocalDateString();
            Object.entries(activeChallenges).forEach(([key, challenge]) => {
                if (challenge.status === 'completed') return; 
                const { categoryKey, amount, oldAmount = 0, newAmount = (amount || 0) } = expenseChange;
                const netChange = newAmount - oldAmount; 
                let newStatus = null;
                if (challenge.challengeId === 'stayUnderBudget' && categoryKey === challenge.targetCategoryKey) {
                    const newTotal = (challenge.currentAmount || 0) + netChange; 
                    updates[`/activeChallenges/${key}/currentAmount`] = newTotal;
                    if (newTotal > challenge.targetAmount) { if (challenge.status !== 'failed') newStatus = 'failed'; } else { if (challenge.status === 'failed') newStatus = 'active'; }
                }
                if (challenge.challengeId === 'goalBooster' && categoryKey === challenge.targetCategoryKey) {
                    const newTotal = (challenge.currentAmount || 0) + netChange; 
                    updates[`/activeChallenges/${key}/currentAmount`] = newTotal;
                    if (newTotal >= challenge.targetAmount) { if (challenge.status !== 'completed') newStatus = 'completed'; } else { if (challenge.status === 'completed') newStatus = 'active'; }
                }
                if (challenge.challengeId === 'noSpend' && categoryKey === challenge.targetCategoryKey && newAmount > 0) {
                    if (challenge.status !== 'failed') newStatus = 'failed';
                }
                if (challenge.challengeId === 'expenseLogger' && newAmount > 0) {
                    if (challenge.lastLogDate !== today) {
                        const newStreak = (challenge.currentStreak || 0) + 1;
                        updates[`/activeChallenges/${key}/currentStreak`] = newStreak;
                        updates[`/activeChallenges/${key}/lastLogDate`] = today;
                        if (newStreak >= challenge.targetDays) newStatus = 'completed';
                    }
                }
                if (newStatus && newStatus !== challenge.status) { 
                    const alertType = (newStatus === 'completed' || newStatus === 'active') ? 'success' : 'failure';
                    if (newStatus === 'completed' && challenge.challengeId !== 'stayUnderBudget') { awardTrophy(key, challenge); } else { updates[`/activeChallenges/${key}/status`] = newStatus; }
                    setTimeout(() => showChallengeAlert(`Challenge Updated: "${CHALLENGE_DEFINITIONS[challenge.challengeId].title}" is now ${newStatus}!`, alertType), 200);
                }
            });
            if (Object.keys(updates).length > 0) { update(dbRef, updates); }
        }
        
        async function logNoSpendDay() {
            if (!state.activeChallenges) return;
            const todayStr = getLocalDateString();
            let challengeKey = null; let challenge = null;
            for (const key in state.activeChallenges) {
                const currentChallenge = state.activeChallenges[key];
                if (currentChallenge.challengeId === 'expenseLogger' && currentChallenge.status === 'active') { challengeKey = key; challenge = currentChallenge; break; }
            }
            if (!challengeKey || !challenge) return;
            const newStreak = (challenge.currentStreak || 0) + 1;
            selectors.noSpendTodayBtn.disabled = true;
            selectors.noSpendTodayBtn.textContent = 'Checked In!';
            if (newStreak >= challenge.targetDays) {
                awardTrophy(challengeKey, challenge);
                showChallengeAlert(`Congratulations! You completed the "Expense Logger" challenge!`);
            } else {
                const updates = {};
                updates[`/activeChallenges/${key}/currentStreak`] = newStreak;
                updates[`/activeChallenges/${key}/lastLogDate`] = todayStr;
                await update(dbRef, updates);
            }
            setTimeout(() => { selectors.noSpendTodayBtn.disabled = false; selectors.noSpendTodayBtn.textContent = '‚úÖ I Didn\'t Spend Today!'; }, 1500);
        }

        // --- START: NEW QUICK ADD FLOW LOGIC ---
        function startQuickAddFlow() {
            const spendingCategories = Object.entries(state.budgetedItems || {})
                .filter(([key, cat]) => cat.type !== 'savings');

            if (spendingCategories.length === 0) {
                alert("Please create at least one spending category before adding an expense.");
                return;
            }

            quickAddState = { step: 1, amount: 0, categoryKey: null, note: '' };
            renderQuickAddStep(1);
            selectors.quickAddModal.style.display = 'flex';
        }

        function renderQuickAddStep(step) {
            quickAddState.step = step;
            // Update progress dots
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                dot.classList.toggle('active', index < step);
            });

            let contentHTML = '';
            selectors.quickAddTitle.textContent = `Quick Add - Step ${step} of 3`;

            switch(step) {
                case 1: // Amount
                    selectors.quickAddTitle.textContent = "Enter Amount";
                    contentHTML = `<div class="input-group"><input type="number" id="qa-amount-input" placeholder="0.00" min="0" step="0.01" inputmode="decimal" style="font-size: 1.5em; padding: 15px; text-align: center;"></div><button id="qa-next-btn" style="width: 100%; margin-top: 10px; padding: 15px; font-size: 1.2em;">Next ‚û°Ô∏è</button>`;
                    selectors.quickAddStepContent.innerHTML = contentHTML;
                    setTimeout(() => document.getElementById('qa-amount-input').focus(), 100);
                    document.getElementById('qa-next-btn').addEventListener('click', handleQuickAddNext);
                    document.getElementById('qa-amount-input').addEventListener('keydown', (e) => {
                         if (e.key === 'Enter') handleQuickAddNext();
                    });
                    break;
                case 2: // Category
                    selectors.quickAddTitle.textContent = "Select Category";
                    const spendingCategories = Object.entries(state.budgetedItems || {})
                        .filter(([key, cat]) => cat.type !== 'savings');
                    contentHTML = `<div id="quick-add-amount-display">${currencyFormatter.format(quickAddState.amount)}</div><div class="quick-add-category-grid">`;
                    spendingCategories.forEach(([key, cat]) => {
                        contentHTML += `<button class="quick-cat-btn" data-key="${key}">${cat.name}</button>`;
                    });
                    contentHTML += `</div>`;
                    selectors.quickAddStepContent.innerHTML = contentHTML;
                    // Add listeners to new category buttons
                    selectors.quickAddStepContent.querySelectorAll('.quick-cat-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            quickAddState.categoryKey = btn.dataset.key;
                            renderQuickAddStep(3);
                        });
                    });
                    break;
                case 3: // Note (Optional) & Save
                    selectors.quickAddTitle.textContent = "Add Note (Optional)";
                    const categoryName = state.budgetedItems[quickAddState.categoryKey].name;
                     contentHTML = `<div style="margin-bottom: 15px; font-size: 1.1em;"><strong>${currencyFormatter.format(quickAddState.amount)}</strong> for <strong>${categoryName}</strong></div>
                     <div class="input-group"><input type="text" id="qa-note-input" placeholder="e.g., Lunch, Coffee..." style="font-size: 1.2em; padding: 15px;"></div>
                     <button id="qa-save-btn" style="width: 100%; margin-top: 15px; padding: 15px; font-size: 1.2em; background-color: var(--income-color);">Save ‚úÖ</button>`;
                    selectors.quickAddStepContent.innerHTML = contentHTML;
                    setTimeout(() => document.getElementById('qa-note-input').focus(), 100);
                    document.getElementById('qa-save-btn').addEventListener('click', finishQuickAddFlow);
                    document.getElementById('qa-note-input').addEventListener('keydown', (e) => {
                         if (e.key === 'Enter') finishQuickAddFlow();
                    });
                    break;
            }
        }

        function handleQuickAddNext() {
            if (quickAddState.step === 1) {
                const amount = parseFloat(document.getElementById('qa-amount-input').value);
                if (amount > 0) {
                    quickAddState.amount = amount;
                    renderQuickAddStep(2);
                } else {
                    alert("Please enter a valid amount.");
                }
            }
        }

        function finishQuickAddFlow() {
            const note = document.getElementById('qa-note-input').value.trim();
            if (quickAddState.amount > 0 && quickAddState.categoryKey) {
                push(ref(db, `budgets/${currentBudgetId}/budgetedItems/${quickAddState.categoryKey}/expenses`), { 
                    amount: quickAddState.amount, 
                    note: note, 
                    date: new Date().toLocaleDateString(), 
                    isEditing: false 
                });
                updateChallengeProgress({ categoryKey: quickAddState.categoryKey, amount: quickAddState.amount });
                selectors.quickAddModal.style.display = 'none';
            }
        }
        // --- END: NEW QUICK ADD FLOW LOGIC ---

        selectors.createNewBudgetBtn.addEventListener('click', startNewBudget);
        selectors.joinBudgetBtn.addEventListener('click', joinBudget);
        selectors.noSpendTodayBtn.addEventListener('click', logNoSpendDay); 

        selectors.showTutorialBtn.addEventListener('click', () => {
            const tutorial = selectors.tutorialSection;
            tutorial.style.display = tutorial.style.display === 'block' ? 'none' : 'block';
        });

        selectors.tutorialSection.addEventListener('click', (e) => {
            const header = e.target.closest('.tutorial-header');
            if (header) {
                const item = header.parentElement;
                item.classList.toggle('active');
            }
        });

        // Use new Quick Add Flow
        selectors.quickAddExpenseBtn.addEventListener('click', startQuickAddFlow);
        selectors.closeQuickAddBtn.addEventListener('click', () => selectors.quickAddModal.style.display = 'none');

        selectors.reviewTabs.addEventListener('click', (e) => {
            const btn = e.target.closest('.tab-btn');
            if (!btn) return;
            const tabId = btn.dataset.tab;
            selectors.reviewTabs.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            if (tabId === 'compare-months-view') {
                renderComparisonView();
            }
        });

        function renderComparisonView() {
            selectors.comparisonChartsArea.innerHTML = '';
            if (history.length < 2) {
                selectors.noComparisonMsg.style.display = 'block';
                return;
            }
            selectors.noComparisonMsg.style.display = 'none';
            selectors.comparisonChartsArea.innerHTML = `
                <div class="chart-container">
                    <div><h3>Cash Flow Comparison</h3><canvas id="comparison-cashflow-chart"></canvas></div>
                    <div><h3>Spending Comparison</h3><canvas id="comparison-spending-chart"></canvas></div>
                </div>`;
            createComparisonCashflowChart(history[0], history[1]);
            createComparisonSpendingChart(history[0], history[1]);
        }

        selectors.addIncomeBtn.addEventListener('click', () => { const name = selectors.incomeNameInput.value.trim(); const amount = parseFloat(selectors.incomeAmountInput.value); if(name && amount > 0) { push(ref(db, `budgets/${currentBudgetId}/income`), { name, amount, isEditing: false }); selectors.incomeNameInput.value = ''; selectors.incomeAmountInput.value = ''; } else { alert('Please enter a valid name and amount.'); } });
        selectors.addExpenseBtn.addEventListener('click', () => { const name = selectors.expenseNameInput.value.trim(); const amount = parseFloat(selectors.expenseAmountInput.value); if(name && amount > 0) { push(ref(db, `budgets/${currentBudgetId}/monthlyExpenses`), { name, amount, isEditing: false }); selectors.expenseNameInput.value = ''; selectors.expenseAmountInput.value = ''; } else { alert('Please enter a valid name and amount.'); } });
        selectors.addCategoryBtn.addEventListener('click', () => { selectors.newCategoryForm.style.display = 'block'; selectors.categoryNameInput.focus(); });
        
        selectors.sinkingFundToggle.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            selectors.categoryLimitInput.style.display = isChecked ? 'none' : 'flex';
            selectors.sinkingFundInputs.style.display = isChecked ? 'block' : 'none';
        });

        selectors.saveCategoryBtn.addEventListener('click', () => { 
            const name = selectors.categoryNameInput.value.trim();
            if (!name) {
                alert('Please enter a category name.');
                return;
            }

            const isSinkingFund = selectors.sinkingFundToggle.checked;
            let newCategoryData;

            if (isSinkingFund) {
                const totalGoal = parseFloat(selectors.sinkingFundGoalInput.value);
                const totalMonths = parseInt(selectors.sinkingFundMonthsInput.value);

                if (totalGoal > 0 && totalMonths > 0) {
                    const monthlyLimit = Math.round(totalGoal / totalMonths);
                    newCategoryData = {
                        name: name,
                        limit: monthlyLimit,
                        isSinkingFund: true,
                        rolloverEnabled: true, 
                        sinkingFundData: {
                            totalGoal: totalGoal,
                            totalMonths: totalMonths,
                            startDate: new Date().toISOString()
                        }
                    };
                } else {
                    alert('Please enter a valid total goal and number of months for the sinking fund.');
                    return;
                }
            } else {
                const limit = parseFloat(selectors.categoryLimitInput.value);
                if (limit >= 0) { 
                    newCategoryData = { name, limit, rolloverEnabled: false };
                } else {
                    alert('Please enter a valid monthly budget limit.');
                    return;
                }
            }

            const newOrder = state.budgetedItems ? Object.keys(state.budgetedItems).length : 0;
            const finalData = { 
                ...newCategoryData,
                expenses: {}, 
                collapsed: true, 
                isEditing: false, 
                order: newOrder, 
                type: 'budget',
                rolloverBalance: 0 
            };
            
            push(ref(db, `budgets/${currentBudgetId}/budgetedItems`), finalData); 
            
            selectors.categoryNameInput.value = ''; 
            selectors.categoryLimitInput.value = ''; 
            selectors.sinkingFundGoalInput.value = '';
            selectors.sinkingFundMonthsInput.value = '';
            selectors.sinkingFundToggle.checked = false;
            selectors.sinkingFundToggle.dispatchEvent(new Event('change'));
            selectors.newCategoryForm.style.display = 'none'; 
        });

        selectors.addSavingsGoalBtn.addEventListener('click', () => { selectors.newSavingsGoalForm.style.display = 'block'; selectors.savingsGoalNameInput.focus(); });
        selectors.saveSavingsGoalBtn.addEventListener('click', () => { const name = selectors.savingsGoalNameInput.value.trim(); const limit = parseFloat(selectors.savingsGoalAmountInput.value); if (name && limit > 0) { const newOrder = state.budgetedItems ? Object.keys(state.budgetedItems).length : 0; push(ref(db, `budgets/${currentBudgetId}/budgetedItems`), { name, limit, expenses: {}, collapsed: true, isEditing: false, order: newOrder, type: 'savings' }); selectors.savingsGoalNameInput.value = ''; selectors.savingsGoalAmountInput.value = ''; selectors.newSavingsGoalForm.style.display = 'none'; } else { alert('Please enter a valid goal name and amount.'); } });
        selectors.incomeExpensesSection.querySelector('.section-header').addEventListener('click', (e) => { if (!e.target.closest('.icon-btn')) { set(ref(db, `budgets/${currentBudgetId}/incomeSectionCollapsed`), !state.incomeSectionCollapsed); } });
        selectors.allocationSection.querySelector('.section-header').addEventListener('click', (e) => { if (!e.target.closest('.icon-btn')) { set(ref(db, `budgets/${currentBudgetId}/allocationSectionCollapsed`), !state.allocationSectionCollapsed); } });
        function toggleAllCategories(isCollapsed) { if (!state.budgetedItems) return; const updates = {}; Object.keys(state.budgetedItems).forEach(key => { if (state.budgetedItems[key].type !== 'savings') updates[`/budgetedItems/${key}/collapsed`] = isCollapsed; }); update(dbRef, updates); }
        selectors.expandAllBtn.addEventListener('click', () => toggleAllCategories(false));
        selectors.collapseAllBtn.addEventListener('click', () => toggleAllCategories(true));
        selectors.reorderToggleBtn.addEventListener('click', () => { const list = selectors.budgetCategoriesList; const isActive = list.classList.toggle('reordering-active'); selectors.reorderToggleBtn.textContent = isActive ? 'Done' : 'Reorder'; renderCategorizedItems(); });
        
        selectors.manageAccountsBtn.addEventListener('click', () => { 
            selectors.sharableIdDisplay.value = currentBudgetId; 
            selectors.editAccountNameInput.value = state.accountName || ''; 
            selectors.toggleChallenges.checked = state.challengesEnabled !== false;
            selectors.accountsModal.style.display = 'flex'; 
        });
        selectors.toggleChallenges.addEventListener('change', (e) => { 
            set(ref(db, `budgets/${currentBudgetId}/challengesEnabled`), e.target.checked); 
        });

        selectors.saveAccountNameBtn.addEventListener('click', () => { const newName = selectors.editAccountNameInput.value.trim(); if (newName) { set(ref(db, `budgets/${currentBudgetId}/accountName`), newName); selectors.saveAccountNameBtn.textContent = 'Saved!'; setTimeout(() => { selectors.saveAccountNameBtn.textContent = 'Save'; closeModal(selectors.accountsModal); }, 1000); } else { alert('Please enter a valid budget name.'); } });
        selectors.copyIdBtn.addEventListener('click', () => { selectors.sharableIdDisplay.select(); document.execCommand('copy'); selectors.copyIdBtn.textContent = 'Copied!'; setTimeout(() => { selectors.copyIdBtn.textContent = 'Copy'; }, 1500); });
        selectors.leaveBudgetBtn.addEventListener('click', () => { localStorage.removeItem('lastBudgetId'); window.location.reload(); });
        
        const closeModal = (modal) => modal.style.display = 'none';
        selectors.closeReviewModalBtn.addEventListener('click', () => closeModal(selectors.reviewModal));
        selectors.closeAccountsModalBtn.addEventListener('click', () => closeModal(selectors.accountsModal));
        selectors.closeChallengeModalBtn.addEventListener('click', () => closeModal(selectors.challengeModal));
        selectors.closeRolloverModalBtn.addEventListener('click', () => closeModal(selectors.rolloverModal));
        selectors.rolloverSkipBtn.addEventListener('click', () => closeModal(selectors.rolloverModal));
        selectors.challengeCenterBtn.addEventListener('click', () => selectors.challengeModal.style.display = 'flex');
        selectors.noHistoryCloseBtn.addEventListener('click', () => closeModal(selectors.reviewModal));
        window.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeModal(selectors.reviewModal); closeModal(selectors.accountsModal); closeModal(selectors.challengeModal); closeModal(selectors.promptModal); closeModal(selectors.confirmModal); closeModal(selectors.rolloverModal); selectors.quickAddModal.style.display = 'none'; } });
        
        selectors.rolloverConfirmBtn.addEventListener('click', () => {
            const updates = {};
            const items = selectors.rolloverSummaryList.querySelectorAll('.rollover-item');
            items.forEach(item => {
                const amount = parseFloat(item.querySelector('.rollover-amount-input').value);
                const savingsKey = item.querySelector('.rollover-savings-select').value;
                const categoryName = item.dataset.categoryName;

                if (amount > 0 && savingsKey) {
                    const newContributionKey = push(ref(db, `budgets/${currentBudgetId}/budgetedItems/${savingsKey}/expenses`)).key;
                    updates[`/budgetedItems/${savingsKey}/expenses/${newContributionKey}`] = {
                        amount: amount,
                        note: `Rollover from ${categoryName}`,
                        date: new Date().toLocaleDateString(),
                        isEditing: false
                    };
                }
            });

            if (Object.keys(updates).length > 0) {
                update(dbRef, updates);
            }
            closeModal(selectors.rolloverModal);
        });

        // --- START: MODIFIED FUNCTION ---
        selectors.reviewBtn.addEventListener('click', () => { 
            selectors.reviewRewardsSection.style.display = 'none';
            selectors.reviewExpenseLogSection.style.display = 'none';
            selectors.monthSelect.innerHTML = ''; 
            if (history.length === 0) { 
                selectors.chartsArea.style.display = 'none'; 
                selectors.reviewControls.style.display = 'none'; 
                selectors.noHistoryMsg.style.display = 'block'; 
            } else { 
                selectors.chartsArea.style.display = 'grid'; 
                selectors.reviewControls.style.display = 'block'; 
                selectors.noHistoryMsg.style.display = 'none'; 
                history.forEach((month, index) => { 
                    const option = document.createElement('option'); 
                    option.value = index; 
                    // Use the formatter function for display
                    option.textContent = formatYearMonth(month.monthYear); 
                    selectors.monthSelect.appendChild(option); 
                }); 
                selectors.monthSelect.dispatchEvent(new Event('change')); 
            } 
            selectors.reviewModal.style.display = 'flex'; 
        });
        // --- END: MODIFIED FUNCTION ---

        selectors.monthSelect.addEventListener('change', (e) => { 
            const selectedMonthData = history[e.target.value]; 
            createCashflowChart(selectedMonthData); 
            createSpendingChart(selectedMonthData);
            renderReviewRewards(selectedMonthData);
            renderReviewExpenseLog(selectedMonthData);
        });

        document.body.addEventListener('click', async (e) => {
            const challengeBadge = e.target.closest('.category-challenge-badge');
            if (challengeBadge) {
                selectors.challengeModal.style.display = 'flex';
                return;
            }
            
            const button = e.target.closest('button');
            if (!button) {
                const categoryHeader = e.target.closest('.budget-category-header');
                if (categoryHeader && !e.target.closest('.icon-btn') && !e.target.closest('.move-btn')) { const key = categoryHeader.dataset.key; const currentCollapsedState = state.budgetedItems[key]?.collapsed || false; set(ref(db, `budgets/${currentBudgetId}/budgetedItems/${key}/collapsed`), !currentCollapsedState); }
                return;
            }

            if (button.classList.contains('start-challenge-btn')) { startChallenge(button.dataset.challengeId); return; }
            if (button.classList.contains('quit-challenge-btn')) { if (await showConfirm('Are you sure you want to quit this challenge? This cannot be undone.')) { remove(ref(db, `budgets/${currentBudgetId}/activeChallenges/${button.dataset.challengeKey}`)); } return; }

            if (button.classList.contains('move-up-btn') || button.classList.contains('move-down-btn')) { const keyToMove = button.dataset.key; let sortedCategories = Object.entries(state.budgetedItems).filter(([k,c]) => c.type !== 'savings').sort((a, b) => a[1].order - b[1].order); const currentIndex = sortedCategories.findIndex(([key, cat]) => key === keyToMove); if (currentIndex === -1) return; const isMovingUp = button.classList.contains('move-up-btn'); const swapIndex = isMovingUp ? currentIndex - 1 : currentIndex + 1; if (swapIndex >= 0 && swapIndex < sortedCategories.length) { const [key1, cat1] = sortedCategories[currentIndex]; const [key2, cat2] = sortedCategories[swapIndex]; const updates = {}; updates[`/budgetedItems/${key1}/order`] = cat2.order; updates[`/budgetedItems/${key2}/order`] = cat1.order; update(dbRef, updates); } return; }

            const { key, type, categoryKey, expenseKey } = button.dataset;
            const dbPath = type === 'income' ? 'income' : 'monthlyExpenses';

            if (button.classList.contains('add-expense-to-category-btn')) {
                const form = button.closest('.new-expense-form');
                const catKey = form.closest('.budget-category').querySelector('.budget-category-header').dataset.key;
                const amountInput = form.querySelector('.expense-amount-input');
                const noteInput = form.querySelector('.expense-note-input');
                const amount = parseFloat(amountInput.value);
                const note = noteInput.value.trim();
                if (amount > 0) {
                    push(ref(db, `budgets/${currentBudgetId}/budgetedItems/${catKey}/expenses`), { amount, note, date: new Date().toLocaleDateString(), isEditing: false });
                    updateChallengeProgress({ categoryKey: catKey, amount });
                    amountInput.value = ''; noteInput.value = '';
                } else { alert('Please enter a valid amount.'); }
            } 
            else if (button.classList.contains('delete-expense-btn')) { 
                const oldExpense = state.budgetedItems[categoryKey]?.expenses[expenseKey]; 
                if (await showConfirm(`Are you sure you want to delete this entry?`)) { 
                    remove(ref(db, `budgets/${currentBudgetId}/budgetedItems/${categoryKey}/expenses/${expenseKey}`)); 
                    if (oldExpense) { 
                        updateChallengeProgress({ categoryKey, oldAmount: oldExpense.amount, newAmount: 0 }); 
                    }
                } 
            } 
            else if (button.classList.contains('delete-btn')) { 
                if (await showConfirm(`Are you sure you want to delete this item?`)) { 
                    if (type === 'income' || type === 'expense') { 
                        remove(ref(db, `budgets/${currentBudgetId}/${dbPath}/${key}`)); 
                    } else if (type === 'category') { 
                        const updates = {};
                        updates[`/budgetedItems/${key}`] = null;
                        if (state.activeChallenges) {
                            for (const challengeKey in state.activeChallenges) {
                                if (state.activeChallenges[challengeKey].targetCategoryKey === key) {
                                    updates[`/activeChallenges/${challengeKey}`] = null;
                                }
                            }
                        }
                        update(dbRef, updates);
                    } 
                } 
            } 
            else if (button.classList.contains('edit-item-btn')) { set(ref(db, `budgets/${currentBudgetId}/${dbPath}/${key}/isEditing`), true); }
            else if (button.classList.contains('cancel-item-btn')) { set(ref(db, `budgets/${currentBudgetId}/${dbPath}/${key}/isEditing`), false); }
            else if (button.classList.contains('save-item-btn')) { const form = button.closest('.input-group'); const newName = form.querySelector('.edit-item-name-input').value.trim(); const newAmount = parseFloat(form.querySelector('.edit-item-amount-input').value); if (newName && newAmount > 0) { update(ref(db, `budgets/${currentBudgetId}/${dbPath}/${key}`), { name: newName, amount: newAmount, isEditing: false }); } else { alert('Please enter a valid name and amount.'); } } 
            else if (button.classList.contains('edit-btn')) { 
                if (button.classList.contains('edit-expense-btn')) { 
                    set(ref(db, `budgets/${currentBudgetId}/budgetedItems/${categoryKey}/expenses/${expenseKey}/isEditing`), true); 
                } else {
                    const item = state.budgetedItems[key];
                    const updates = {};
                    updates[`/budgetedItems/${key}/isEditing`] = !item.isEditing;
                    if (item.collapsed) {
                        updates[`/budgetedItems/${key}/collapsed`] = false;
                    }
                    update(dbRef, updates);
                } 
            } 
            else if (button.classList.contains('save-edit-btn')) { 
                const form = button.closest('.edit-category-form');
                const item = state.budgetedItems[key];
                const newName = form.querySelector('.edit-name-input').value.trim();
                
                if (item.isSinkingFund) {
                    const newGoal = parseFloat(form.querySelector('.edit-sf-goal-input').value);
                    const newMonths = parseInt(form.querySelector('.edit-sf-months-input').value);
                    if (newName && newGoal > 0 && newMonths > 0) {
                        const newLimit = Math.round(newGoal / newMonths);
                        const updates = {
                            name: newName,
                            limit: newLimit,
                            'sinkingFundData/totalGoal': newGoal,
                            'sinkingFundData/totalMonths': newMonths,
                            isEditing: false
                        };
                        update(ref(db, `budgets/${currentBudgetId}/budgetedItems/${key}`), updates);
                    } else {
                        alert('Please enter a valid name, goal, and number of months.');
                    }
                } else {
                    const newLimit = parseFloat(form.querySelector('.edit-limit-input').value);
                    const rolloverCheckbox = form.querySelector('.edit-rollover-toggle');
                    
                    if (newName && newLimit >= 0) {
                        const updates = { name: newName, limit: newLimit, isEditing: false };
                        if(rolloverCheckbox) {
                            updates.rolloverEnabled = rolloverCheckbox.checked;
                        }
                        update(ref(db, `budgets/${currentBudgetId}/budgetedItems/${key}`), updates); 
                    } else { 
                        alert('Please enter a valid name and limit/goal amount.'); 
                    }
                }
            } 
            else if (button.classList.contains('save-edit-expense-btn')) { 
                const form = button.closest('li'); 
                const newAmount = parseFloat(form.querySelector('.edit-expense-amount-input').value); 
                const newNote = form.querySelector('.edit-expense-note-input').value.trim();
                const dateValue = form.querySelector('.edit-expense-date-input').value;

                const oldExpense = state.budgetedItems[categoryKey]?.expenses[expenseKey]; 

                if (newAmount > 0 && dateValue) { 
                    const newDate = new Date(dateValue + 'T00:00:00').toLocaleDateString();
                    update(ref(db, `budgets/${currentBudgetId}/budgetedItems/${categoryKey}/expenses/${expenseKey}`), { date: newDate, amount: newAmount, note: newNote, isEditing: false }); 
                    
                    if (oldExpense) { 
                        updateChallengeProgress({ categoryKey, oldAmount: oldExpense.amount, newAmount: newAmount }); 
                    } else {
                        updateChallengeProgress({ categoryKey, amount: newAmount });
                    }
                } else { 
                    alert('Please enter a valid amount and select a date.'); 
                } 
            } 
            else if (button.classList.contains('cancel-edit-btn')) { set(ref(db, `budgets/${currentBudgetId}/budgetedItems/${key}/isEditing`), false); } 
            else if (button.classList.contains('cancel-edit-expense-btn')) { set(ref(db, `budgets/${currentBudgetId}/budgetedItems/${categoryKey}/expenses/${expenseKey}/isEditing`), false); }
        });
        
        const lastBudgetId = localStorage.getItem('lastBudgetId');
        if (lastBudgetId) { connectToBudget(lastBudgetId); }
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>