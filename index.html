<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Buddy</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-bg: #f4f7f9; --secondary-bg: #ffffff; --text-color: #333; --accent-color: #4a90e2; --accent-hover: #357abd; --income-color: #2ecc71; --expense-color: #e74c3c; --border-color: #e0e0e0; --shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--primary-bg); color: var(--text-color); margin: 0; padding: 20px; font-size: 16px; }
        .container { 
            max-width: 800px; margin: 0 auto; background-color: var(--secondary-bg); 
            border-radius: 10px; box-shadow: var(--shadow); padding: 20px;
            position: relative; /* For positioning elements */
        }
        #app-logo {
            position: absolute;
            top: 25px;
            left: 25px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
        }
        header { text-align: center; border-bottom: 2px solid var(--border-color); padding-bottom: 20px; margin-bottom: 20px; }
        h1 { color: var(--accent-color); margin: 0; }
        #current-account-name {
            font-size: 1.6em;
            margin: 10px 0 0 0;
            color: #555;
        }
        .summary-display { background: linear-gradient(135deg, var(--accent-color), var(--accent-hover)); color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
        .summary-display h2 { margin: 0; font-size: 1.2em; font-weight: 500; color: white; }
        .summary-display p { font-size: 2.5em; font-weight: bold; margin: 5px 0 0; }
        .section { margin-bottom: 25px; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 10px; }
        .section-header h3 { margin: 0; }
        .toggle-icon { font-size: 1.5em; transition: transform 0.3s; }
        .section.collapsed .section-content, .section.collapsed .add-category-btn, .section.collapsed .hidden-form { display: none; }
        .section.collapsed > .section-header { margin-bottom: 0; border-bottom: none; }
        .section.collapsed .section-summary-view { display: flex; justify-content: space-around; background-color: #f7f7f7; padding: 10px; border-radius: 5px; font-size: 0.9em; }
        .section.collapsed > .section-header .toggle-icon { transform: rotate(-90deg); }
        .input-group { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .input-group:last-child { margin-bottom: 0; }
        .input-group input { flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; width: 100%; }
        button { padding: 10px 15px; border: none; border-radius: 5px; background-color: var(--accent-color); color: white; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: var(--accent-hover); }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 1.2em; padding: 5px; flex-shrink: 0; }
        .delete-btn { color: var(--expense-color); }
        .edit-btn { color: var(--accent-color); }
        .add-category-btn { width: 100%; margin-top: 10px; background-color: #f0f0f0; color: var(--text-color); }
        .category-controls { display: flex; gap: 5px; }
        .control-btn { font-size: 0.8em; padding: 5px 10px; background-color: #e9e9e9; color: var(--text-color); }
        #manage-accounts-btn {
            position: absolute;
            top: 25px;
            right: 25px;
        }
        .budget-category { border: 1px solid var(--border-color); border-radius: 5px; padding: 10px; background-color: #fafafa; margin-bottom: 10px; }
        .budget-category:last-child { margin-bottom: 0; }
        .budget-category-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: bold; }
        .budget-category.collapsed .toggle-icon { transform: rotate(-90deg); }
        .budget-category.collapsed .budget-category-content { display: none; }
        .budget-category-content { margin-top: 10px; }
        .budget-summary-text { font-size: 0.9em; font-weight: normal; color: #555; margin-top: 5px; }
        .progress-bar { width: 100%; background-color: #e0e0e0; border-radius: 5px; height: 10px; margin-top: 8px; overflow: hidden; position: relative; }
        .progress-bar-inner { height: 100%; border-radius: 5px; transition: width 0.4s ease-in-out, background-color 0.4s ease-in-out; position: absolute; top: 0; left: 0; }
        .progress-bar-remaining { background-color: var(--income-color); }
        .progress-bar-overspent { background-color: var(--expense-color); }
        .edit-category-form, .edit-expense-form { padding: 10px; background-color: #eaf2fa; border-radius: 5px; }
        .expense-log { list-style: none; padding: 0; margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .expense-log li { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; font-size: 0.9em; flex-wrap: wrap; }
        .expense-log .date-stamp { color: #888; font-size: 0.9em; margin: 0 10px; flex-shrink: 0; white-space: nowrap; }
        .expense-log .amount { font-weight: 500; margin-right: 5px; }
        .expense-log .note { color: #777; font-style: italic; margin-left: 5px; flex-grow: 1; word-break: break-all; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; }
        #confirm-modal .modal-content, #onboarding-modal .modal-content, #accounts-modal .modal-content { max-width: 400px; text-align: center; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .modal-header .close-btn { font-size: 1.8em; cursor: pointer; background: none; border: none; padding: 0 10px; color: #333; }
        .chart-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .confirm-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        #onboarding-modal { display: flex; } /* Show onboarding by default */
        .app-content { display: none; } /* Hide app content by default */
        
        /* New styles for reordering */
        .reorder-controls {
            display: none; /* Hidden by default */
            align-items: center;
            margin-right: 10px; /* Spacing between arrows and name */
            gap: 5px;
        }
        .reordering-active .reorder-controls {
            display: inline-flex; /* Use inline-flex to appear next to the name */
        }
        .move-btn {
            background: none;
            border: 1px solid #ccc;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 1em;
            padding: 0;
            line-height: 26px; /* Center the arrow */
            color: var(--text-color);
        }
        .move-btn:hover {
            background-color: #f0f0f0;
        }
        .move-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        /* Hide regular controls while reordering */
        .reordering-active .budget-category-header .edit-btn,
        .reordering-active .budget-category-header .delete-btn {
            display: none;
        }
        
        @media (max-width: 600px) { 
            .chart-container { grid-template-columns: 1fr; } 
            #manage-accounts-btn { top: 15px; right: 15px; }
            #app-logo { top: 15px; left: 15px; }
        }
    </style>
</head>
<body>
    <div class="container app-content">
        <div id="app-logo">BB</div>
        <button id="manage-accounts-btn" class="control-btn">Settings & Share</button>
        <header>
            <h1>Budget Buddy</h1>
            <h2 id="current-account-name"></h2>
            <p id="current-month" style="margin-top: 10px;"></p>
        </header>
        <button id="review-btn" style="width: 100%; margin-bottom: 20px;">📊 Monthly Review</button>
        
        <div class="section" id="income-expenses-section">
            <div class="section-header"><h3>💰 Income & Fixed Expenses</h3><div class="toggle-icon">▼</div></div>
            <div class="section-summary-view"><span>Total Income: <strong id="summary-total-income">$0.00</strong></span><span>Total Expenses: <strong id="summary-total-expenses">$0.00</strong></span></div>
            <div class="section-content">
                <h4>Income</h4><div id="income-list"></div><div class="input-group"><input type="text" id="income-name-input" placeholder="e.g., Paycheck"><input type="number" id="income-amount-input" placeholder="Amount" min="0" step="0.01"><button id="add-income-btn" class="add-btn">+</button></div><hr>
                <h4>Monthly Fixed Expenses</h4><div id="expense-list"></div><div class="input-group"><input type="text" id="expense-name-input" placeholder="e.g., Rent"><input type="number" id="expense-amount-input" placeholder="Amount" min="0" step="0.01"><button id="add-expense-btn" class="add-btn">+</button></div>
            </div>
        </div>

        <div class="section">
            <div class="summary-display budget-section-summary"><h2>Remaining to Spend</h2><p id="remaining-to-spend">$0.00</p></div>
            
            <div class="section" id="allocation-section" style="padding: 15px; border-style: dashed; margin-bottom: 20px;">
                <div class="section-header" style="padding-bottom:10px; border-bottom: 1px solid var(--border-color); margin-bottom:10px;">
                    <h3>📊 Budget Allocation</h3>
                    <div class="toggle-icon">▼</div>
                </div>
                <div class="section-content">
                    <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 8px;">
                        <span><strong>Total to Budget:</strong> <span id="total-to-budget">$0.00</span></span>
                        <span><strong>Allocated:</strong> <span id="allocated-in-budgets">$0.00</span></span>
                    </div>
                    <div class="progress-bar" style="height: 12px; margin-top: 5px;">
                        <div id="allocation-progress-bar" class="progress-bar-inner"></div>
                    </div>
                    <div style="text-align: right; font-weight: bold; margin-top: 8px;">
                        Remaining to Allocate: <span id="remaining-to-allocate">$0.00</span>
                    </div>
                </div>
            </div>

            <div class="section-header">
                <h3>🛒 Budgeted Spending</h3>
                <div class="category-controls">
                    <button id="reorder-toggle-btn" class="control-btn">Reorder</button>
                    <button id="expand-all-btn" class="control-btn">Expand All</button>
                    <button id="collapse-all-btn" class="control-btn">Collapse All</button>
                </div>
            </div>
            <div class="section-content" id="budget-categories-list"></div>
            <button class="add-category-btn" id="add-category-btn">+ New Budget Category</button>
            <div class="hidden-form" id="new-category-form"><div class="input-group"><input type="text" id="category-name-input" placeholder="Category Name"><input type="number" id="category-limit-input" placeholder="Budget Limit" min="0" step="0.01"><button id="save-category-btn">Save</button></div></div>
        </div>
    </div>

    <div class="modal-overlay" id="onboarding-modal"><div class="modal-content"><div class="modal-header"><h2>Welcome to Budget Buddy</h2></div><p>Create a new budget to share, or join one using an ID from a friend.</p><button id="create-new-budget-btn" style="width: 100%; margin-bottom: 15px;">Create a New Shared Budget</button><hr><p style="margin-top: 15px;"><strong>Or Join Existing Budget</strong></p><div class="input-group"><input type="text" id="join-budget-id-input" placeholder="Enter Sharable ID"><button id="join-budget-btn">Join</button></div></div></div>
    <div class="modal-overlay" id="review-modal"><div class="modal-content"><div class="modal-header"><h2>Monthly Review</h2><button class="close-btn" id="close-review-modal-btn">&times;</button></div><div id="review-content"><div id="review-controls" style="width: 100%;"><label for="month-select">Select Month:</label><select id="month-select" style="padding: 8px; width: 100%;"></select></div><div id="no-history-msg" style="display: none; text-align: center; margin-top: 20px;"><p>No historical data for this budget yet.</p><button id="no-history-close-btn" style="margin-top: 15px;">Go Back</button></div><div class="chart-container" id="charts-area"><div><h3>Cash Flow</h3><canvas id="cashflow-chart"></canvas></div><div><h3>Spending Breakdown</h3><canvas id="spending-chart"></canvas></div></div></div></div></div>
    <div class="modal-overlay" id="accounts-modal"><div class="modal-content"><div class="modal-header"><h2>Budget Settings & Sharing</h2><button class="close-btn" id="close-accounts-modal-btn">&times;</button></div><div id="accounts-content"><h3>Edit Budget Name</h3><div class="input-group"><input type="text" id="edit-account-name-input" placeholder="Budget Name"><button id="save-account-name-btn">Save</button></div><hr><h3>Your Sharable Budget ID</h3><p style="font-size: 0.9em; color: #555;">Give this ID to others so they can join and edit this budget in real-time.</p><div class="input-group"><input type="text" id="sharable-id-display" readonly style="background-color: #f0f0f0; font-weight: bold;"><button id="copy-id-btn">Copy</button></div><hr><button id="leave-budget-btn" style="width:100%; background-color: var(--expense-color);">Leave Budget</button></div></div></div>
    <div class="modal-overlay" id="confirm-modal"><div class="modal-content"><p id="confirm-msg"></p><div class="confirm-actions"><button id="confirm-cancel-btn" style="background-color: #777;">Cancel</button><button id="confirm-ok-btn" style="background-color: var(--expense-color);">Confirm</button></div></div></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove, update, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAyPf2h3NhhHa1HqyHGkp7kvID72iVM0q8", authDomain: "simple-budget-43c48.firebaseapp.com", databaseURL: "https://simple-budget-43c48-default-rtdb.firebaseio.com", projectId: "simple-budget-43c48", storageBucket: "simple-budget-43c48.firebasestorage.app", messagingSenderId: "227409147398", appId: "1:227409147398:web:5cc2085c35021220daf587", measurementId: "G-MNJNXG67ST" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let state = {}; 
        let currentBudgetId = null;
        let dbRef = null;
        let history = [];
        let cashflowChartInstance, spendingChartInstance;

        const selectors = {
            appContent: document.querySelector('.app-content'),
            remainingToSpend: document.getElementById('remaining-to-spend'), currentMonth: document.getElementById('current-month'), 
            incomeList: document.getElementById('income-list'), incomeNameInput: document.getElementById('income-name-input'), incomeAmountInput: document.getElementById('income-amount-input'), addIncomeBtn: document.getElementById('add-income-btn'), 
            expenseList: document.getElementById('expense-list'), expenseNameInput: document.getElementById('expense-name-input'), expenseAmountInput: document.getElementById('expense-amount-input'), addExpenseBtn: document.getElementById('add-expense-btn'), 
            budgetCategoriesList: document.getElementById('budget-categories-list'), addCategoryBtn: document.getElementById('add-category-btn'), newCategoryForm: document.getElementById('new-category-form'), categoryNameInput: document.getElementById('category-name-input'), categoryLimitInput: document.getElementById('category-limit-input'), saveCategoryBtn: document.getElementById('save-category-btn'), 
            incomeExpensesSection: document.getElementById('income-expenses-section'),
            allocationSection: document.getElementById('allocation-section'),
            summaryTotalIncome: document.getElementById('summary-total-income'), summaryTotalExpenses: document.getElementById('summary-total-expenses'),
            expandAllBtn: document.getElementById('expand-all-btn'), collapseAllBtn: document.getElementById('collapse-all-btn'),
            reorderToggleBtn: document.getElementById('reorder-toggle-btn'), // Added selector
            reviewBtn: document.getElementById('review-btn'), reviewModal: document.getElementById('review-modal'), closeReviewModalBtn: document.getElementById('close-review-modal-btn'),
            monthSelect: document.getElementById('month-select'), chartsArea: document.getElementById('charts-area'), noHistoryMsg: document.getElementById('no-history-msg'),
            reviewControls: document.getElementById('review-controls'), noHistoryCloseBtn: document.getElementById('no-history-close-btn'),
            currentAccountName: document.getElementById('current-account-name'), manageAccountsBtn: document.getElementById('manage-accounts-btn'),
            accountsModal: document.getElementById('accounts-modal'), closeAccountsModalBtn: document.getElementById('close-accounts-modal-btn'),
            sharableIdDisplay: document.getElementById('sharable-id-display'), copyIdBtn: document.getElementById('copy-id-btn'), leaveBudgetBtn: document.getElementById('leave-budget-btn'),
            editAccountNameInput: document.getElementById('edit-account-name-input'), saveAccountNameBtn: document.getElementById('save-account-name-btn'),
            confirmModal: document.getElementById('confirm-modal'), confirmMsg: document.getElementById('confirm-msg'), confirmOkBtn: document.getElementById('confirm-ok-btn'), confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
            onboardingModal: document.getElementById('onboarding-modal'), createNewBudgetBtn: document.getElementById('create-new-budget-btn'), joinBudgetBtn: document.getElementById('join-budget-btn'), joinBudgetIdInput: document.getElementById('join-budget-id-input'),
            totalToBudget: document.getElementById('total-to-budget'), allocatedInBudgets: document.getElementById('allocated-in-budgets'), remainingToAllocate: document.getElementById('remaining-to-allocate'), allocationProgressBar: document.getElementById('allocation-progress-bar'),
        };

        const currencyFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
        
        function createNewBudget() { return { accountName: 'My Shared Budget', income: {}, monthlyExpenses: {}, budgetedItems: {}, monthYear: new Date().toLocaleString('default', { month: 'long', year: 'numeric' }), incomeSectionCollapsed: false, allocationSectionCollapsed: false, history: {}, }; }
        function startNewBudget() { const newBudgetRef = push(ref(db, 'budgets')); const newBudgetId = newBudgetRef.key; set(newBudgetRef, createNewBudget()); connectToBudget(newBudgetId); }
        async function joinBudget() { const budgetId = selectors.joinBudgetIdInput.value.trim(); if (!budgetId) { alert('Please enter a budget ID.'); return; } const budgetRef = ref(db, `budgets/${budgetId}`); const snapshot = await get(budgetRef); if (snapshot.exists()) { connectToBudget(budgetId); } else { alert('Budget ID not found. Please check the ID and try again.'); } }
        function connectToBudget(budgetId) {
            currentBudgetId = budgetId;
            dbRef = ref(db, `budgets/${currentBudgetId}`);
            onValue(dbRef, (snapshot) => { const data = snapshot.val(); if (data) { state = data; history = state.history ? Object.values(state.history).sort((a,b) => new Date(b.monthYear).getTime() - new Date(a.monthYear).getTime()) : []; checkForNewMonth(); render(); selectors.onboardingModal.style.display = 'none'; selectors.appContent.style.display = 'block'; } });
            localStorage.setItem('lastBudgetId', budgetId);
        }
        function checkForNewMonth() { const currentMonthYear = new Date().toLocaleString('default', { month: 'long', year: 'numeric' }); if (state.monthYear && state.monthYear !== currentMonthYear) { alert(`Welcome to a new month! Your previous month's data for "${state.accountName}" has been archived.`); const oldStateForHistory = { ...state }; delete oldStateForHistory.history; const historyRef = push(ref(db, `budgets/${currentBudgetId}/history`)); set(historyRef, oldStateForHistory); const newBudgets = state.budgetedItems ? Object.entries(state.budgetedItems).reduce((acc, [key, category]) => { const totalSpent = (category.expenses ? Object.values(category.expenses) : []).reduce((sum, exp) => sum + exp.amount, 0); const unspent = category.limit - totalSpent; const newLimit = unspent > 0 ? category.limit + unspent : category.limit; acc[key] = { name: category.name, limit: newLimit, expenses: {}, collapsed: false, isEditing: false }; return acc; }, {}) : {}; const newMonthData = { ...state, monthYear: currentMonthYear, budgetedItems: newBudgets }; set(dbRef, newMonthData); } }
        function showConfirm(message) { return new Promise(resolve => { selectors.confirmMsg.textContent = message; selectors.confirmModal.style.display = 'flex'; const onOk = () => { selectors.confirmModal.style.display = 'none'; cleanup(); resolve(true); }; const onCancel = () => { selectors.confirmModal.style.display = 'none'; cleanup(); resolve(false); }; const cleanup = () => { selectors.confirmOkBtn.removeEventListener('click', onOk); selectors.confirmCancelBtn.removeEventListener('click', onCancel); }; selectors.confirmOkBtn.addEventListener('click', onOk); selectors.confirmCancelBtn.addEventListener('click', onCancel); }); }
        
        const toArray = (obj) => obj ? Object.values(obj) : [];
        const calculateTotalIncome = (data) => toArray(data.income).reduce((sum, item) => sum + item.amount, 0);
        const calculateTotalMonthlyExpenses = (data) => toArray(data.monthlyExpenses).reduce((sum, item) => sum + item.amount, 0);
        const calculateTotalBudgetedSpending = (data) => toArray(data.budgetedItems).flatMap(cat => toArray(cat.expenses)).reduce((sum, exp) => sum + exp.amount, 0);
        const calculateIncomeAfterBills = (data) => calculateTotalIncome(data) - calculateTotalMonthlyExpenses(data);
        const calculateTotalAllocated = (data) => toArray(data.budgetedItems).reduce((sum, cat) => sum + cat.limit, 0);

        function getColorForPercentage(percent) {
            percent = Math.max(0, Math.min(100, percent));
            const startColor = { r: 46, g: 204, b: 113 };
            const endColor = { r: 255, g: 193, b: 7 };
            const r = Math.round(startColor.r + (endColor.r - startColor.r) * (1 - percent / 100));
            const g = Math.round(startColor.g + (endColor.g - startColor.g) * (1 - percent / 100));
            const b = Math.round(startColor.b + (endColor.b - startColor.b) * (1 - percent / 100));
            return `rgb(${r}, ${g}, ${b})`;
        }

        function render() {
            if(!state) return;
            const incomeAfterBills = calculateIncomeAfterBills(state);
            selectors.remainingToSpend.textContent = currencyFormatter.format(incomeAfterBills - calculateTotalBudgetedSpending(state));
            selectors.summaryTotalIncome.textContent = currencyFormatter.format(calculateTotalIncome(state));
            selectors.summaryTotalExpenses.textContent = currencyFormatter.format(calculateTotalMonthlyExpenses(state));
            
            const totalAllocated = calculateTotalAllocated(state);
            const remainingToAllocate = incomeAfterBills - totalAllocated;
            const remainingPercent = incomeAfterBills > 0 ? (remainingToAllocate / incomeAfterBills) * 100 : (remainingToAllocate > 0 ? 100 : 0);
            
            selectors.totalToBudget.textContent = currencyFormatter.format(incomeAfterBills);
            selectors.allocatedInBudgets.textContent = currencyFormatter.format(totalAllocated);
            selectors.remainingToAllocate.textContent = currencyFormatter.format(remainingToAllocate);
            selectors.allocationProgressBar.style.width = `${Math.max(0, remainingPercent)}%`;
            selectors.allocationProgressBar.style.backgroundColor = getColorForPercentage(remainingPercent);
            if (remainingToAllocate < 0) { selectors.remainingToAllocate.style.color = 'var(--expense-color)'; } else { selectors.remainingToAllocate.style.color = 'var(--text-color)'; }

            renderList(state.income, selectors.incomeList, 'income');
            renderList(state.monthlyExpenses, selectors.expenseList, 'expense');
            renderBudgetCategories();
            if (state.incomeSectionCollapsed) selectors.incomeExpensesSection.classList.add('collapsed'); else selectors.incomeExpensesSection.classList.remove('collapsed');
            if (state.allocationSectionCollapsed) selectors.allocationSection.classList.add('collapsed'); else selectors.allocationSection.classList.remove('collapsed');
            renderHeader();
        }

        function renderList(items, element, type) {
            element.innerHTML = '';
            if (!items) return;
            Object.entries(items).forEach(([key, item]) => {
                let itemHtml = '';
                if (item.isEditing) {
                    itemHtml = `
                        <div class="input-group">
                            <input type="text" class="edit-item-name-input" value="${item.name}">
                            <input type="number" class="edit-item-amount-input" value="${item.amount.toFixed(2)}" min="0" step="0.01">
                            <button class="save-item-btn" data-key="${key}" data-type="${type}">Save</button>
                            <button class="cancel-item-btn" style="background-color:#777" data-key="${key}" data-type="${type}">Cancel</button>
                        </div>`;
                } else {
                    itemHtml = `
                        <div class="input-group">
                            <input type="text" value="${item.name}" readonly>
                            <input type="number" value="${item.amount.toFixed(2)}" readonly>
                            <button class="icon-btn edit-btn edit-item-btn" data-key="${key}" data-type="${type}">✏️</button>
                            <button class="icon-btn delete-btn" data-key="${key}" data-type="${type}">✖</button>
                        </div>`;
                }
                element.innerHTML += itemHtml;
            });
        }

        function renderBudgetCategories() {
            selectors.budgetCategoriesList.innerHTML = '';
            if (!state.budgetedItems) return;

            // --- NEW LOGIC: Convert to array, handle missing 'order', and sort ---
            const updates = {};
            let sortedCategories = Object.entries(state.budgetedItems).map(([key, cat], index) => {
                // This handles older categories that don't have an order property yet.
                if (cat.order === undefined) {
                    cat.order = index;
                    updates[`/budgetedItems/${key}/order`] = index;
                }
                return [key, cat];
            });

            // If we found any items without an order, update the database.
            if (Object.keys(updates).length > 0) {
                update(dbRef, updates);
            }

            sortedCategories.sort((a, b) => a[1].order - b[1].order);
            const isReordering = selectors.budgetCategoriesList.classList.contains('reordering-active');
            // --- END NEW LOGIC ---

            // Now, loop through the SORTED array
            sortedCategories.forEach(([key, category], index) => {
                const categoryDiv = document.createElement('div');
                if (category.isEditing) {
                    categoryDiv.className = 'budget-category';
                    categoryDiv.innerHTML = `<div class="edit-category-form"><p><strong>Edit Category</strong></p><div class="input-group"><input type="text" class="edit-name-input" value="${category.name}"><input type="number" class="edit-limit-input" value="${category.limit.toFixed(2)}" min="0" step="0.01"></div><div style="margin-top: 10px; display: flex; gap: 10px;"><button class="save-edit-btn" data-key="${key}">Save</button><button class="cancel-edit-btn" data-key="${key}" style="background-color: #777;">Cancel</button></div></div>`;
                } else {
                    categoryDiv.className = `budget-category ${category.collapsed ? 'collapsed' : ''}`;
                    const totalSpent = toArray(category.expenses).reduce((sum, exp) => sum + exp.amount, 0);
                    const remainingPercent = category.limit > 0 ? Math.max(0, 100 * (category.limit - totalSpent) / category.limit) : 100;
                    const overspentPercent = category.limit > 0 ? Math.max(0, 100 * (totalSpent - category.limit) / category.limit) : 0;
                    const barColor = getColorForPercentage(remainingPercent);
                    const expenseLogsHTML = category.expenses ? Object.entries(category.expenses).map(([expKey, exp]) => { if (exp.isEditing) { return `<li class="edit-expense-form"><div class="input-group"><input type="number" class="edit-expense-amount-input" value="${exp.amount.toFixed(2)}"><input type="text" class="edit-expense-note-input" value="${exp.note || ''}"></div><div style="margin-top:5px; display:flex; gap:5px;"><button class="save-edit-expense-btn" data-category-key="${key}" data-expense-key="${expKey}">Save</button><button class="cancel-edit-expense-btn" data-category-key="${key}" data-expense-key="${expKey}" style="background-color:#777">Cancel</button></div></li>`; } return `<li><span class="amount">${currencyFormatter.format(exp.amount)}</span><span class="note">${exp.note}</span><span class="date-stamp">${exp.date || ''}</span><div style="display:flex; gap:5px;"><button class="icon-btn edit-btn edit-expense-btn" data-category-key="${key}" data-expense-key="${expKey}">✏️</button><button class="icon-btn delete-btn delete-expense-btn" data-category-key="${key}" data-expense-key="${expKey}">✖</button></div></li>`; }).join('') : '';
                    
                    // --- NEW: HTML for reorder controls ---
                    const reorderControlsHTML = `
                        <span class="reorder-controls">
                            <button class="move-btn move-up-btn" data-key="${key}" ${index === 0 ? 'disabled' : ''}>🔼</button>
                            <button class="move-btn move-down-btn" data-key="${key}" ${index === sortedCategories.length - 1 ? 'disabled' : ''}>🔽</button>
                        </span>
                    `;

                    categoryDiv.innerHTML = `
                        <div class="budget-category-header" data-key="${key}">
                            <span style="display: flex; align-items: center;">${reorderControlsHTML}${category.name}</span>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <button class="icon-btn edit-btn" data-key="${key}">✏️</button>
                                <button class="icon-btn delete-btn" data-key="${key}" data-type="category">✖</button>
                                <span class="toggle-icon" style="margin-left: 15px;">▼</span>
                            </div>
                        </div>
                        <div class="budget-summary-text">${currencyFormatter.format(totalSpent)} spent of ${currencyFormatter.format(category.limit)}</div>
                        <div class="progress-bar">
                            <div class="progress-bar-inner" style="width: ${remainingPercent}%; background-color: ${barColor};"></div>
                            <div class="progress-bar-inner progress-bar-overspent" style="width: ${overspentPercent}%;"></div>
                        </div>
                        <div class="budget-category-content"><div class="new-expense-form"><div class="input-group"><input type="number" placeholder="Amount" class="expense-amount-input" min="0" step="0.01"><input type="text" placeholder="Note (optional)" class="expense-note-input"><button class="add-expense-to-category-btn">Add Expense</button></div></div><ul class="expense-log">${expenseLogsHTML}</ul></div>`;
                }
                selectors.budgetCategoriesList.appendChild(categoryDiv);
            });
        }
        function renderHeader() { const accountName = state.accountName || `Shared Budget`; document.title = `Budget Buddy - ${accountName}`; selectors.currentAccountName.textContent = accountName; selectors.currentMonth.textContent = state.monthYear; }
        function createCashflowChart(monthData) { if(cashflowChartInstance) cashflowChartInstance.destroy(); const totalIncome = calculateTotalIncome(monthData); const totalSpending = calculateTotalMonthlyExpenses(monthData) + calculateTotalBudgetedSpending(monthData); const ctx = document.getElementById('cashflow-chart').getContext('2d'); cashflowChartInstance = new Chart(ctx, { type: 'bar', data: { labels: ['Total Income', 'Total Spending'], datasets: [{ label: 'Amount', data: [totalIncome, totalSpending], backgroundColor: ['rgba(46, 204, 113, 0.7)', 'rgba(231, 76, 60, 0.7)'], borderColor: ['#2ecc71', '#e74c3c'], borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } }); }
        function createSpendingChart(monthData) { if(spendingChartInstance) spendingChartInstance.destroy(); const categorySpending = toArray(monthData.budgetedItems).map(cat => ({ name: cat.name, total: toArray(cat.expenses).reduce((sum, exp) => sum + exp.amount, 0) })).filter(c => c.total > 0); const ctx = document.getElementById('spending-chart').getContext('2d'); spendingChartInstance = new Chart(ctx, { type: 'pie', data: { labels: categorySpending.map(c => c.name), datasets: [{ data: categorySpending.map(c => c.total), borderWidth: 1 }] }, options: { plugins: { legend: { position: 'bottom' } } } }); }

        selectors.createNewBudgetBtn.addEventListener('click', startNewBudget);
        selectors.joinBudgetBtn.addEventListener('click', joinBudget);
        selectors.addIncomeBtn.addEventListener('click', () => { const name = selectors.incomeNameInput.value.trim(); const amount = parseFloat(selectors.incomeAmountInput.value); if(name && amount > 0) { push(ref(db, `budgets/${currentBudgetId}/income`), { name, amount, isEditing: false }); selectors.incomeNameInput.value = ''; selectors.incomeAmountInput.value = ''; } else { alert('Please enter a valid name and amount.'); } });
        selectors.addExpenseBtn.addEventListener('click', () => { const name = selectors.expenseNameInput.value.trim(); const amount = parseFloat(selectors.expenseAmountInput.value); if(name && amount > 0) { push(ref(db, `budgets/${currentBudgetId}/monthlyExpenses`), { name, amount, isEditing: false }); selectors.expenseNameInput.value = ''; selectors.expenseAmountInput.value = ''; } else { alert('Please enter a valid name and amount.'); } });
        selectors.addCategoryBtn.addEventListener('click', () => { selectors.newCategoryForm.style.display = 'block'; selectors.categoryNameInput.focus(); });
        selectors.saveCategoryBtn.addEventListener('click', () => { const name = selectors.categoryNameInput.value.trim(); const limit = parseFloat(selectors.categoryLimitInput.value); if (name && limit > 0) { const newOrder = state.budgetedItems ? Object.keys(state.budgetedItems).length : 0; push(ref(db, `budgets/${currentBudgetId}/budgetedItems`), { name, limit, expenses: {}, collapsed: false, isEditing: false, order: newOrder }); selectors.categoryNameInput.value = ''; selectors.categoryLimitInput.value = ''; selectors.newCategoryForm.style.display = 'none'; } else { alert('Please enter a valid category name and budget limit.'); } });
        selectors.incomeExpensesSection.querySelector('.section-header').addEventListener('click', (e) => { if (!e.target.closest('.icon-btn')) { set(ref(db, `budgets/${currentBudgetId}/incomeSectionCollapsed`), !state.incomeSectionCollapsed); } });
        selectors.allocationSection.querySelector('.section-header').addEventListener('click', (e) => { if (!e.target.closest('.icon-btn')) { set(ref(db, `budgets/${currentBudgetId}/allocationSectionCollapsed`), !state.allocationSectionCollapsed); } });
        function toggleAllCategories(isCollapsed) { if (!state.budgetedItems) return; const updates = {}; Object.keys(state.budgetedItems).forEach(key => { updates[`/budgetedItems/${key}/collapsed`] = isCollapsed; }); update(dbRef, updates); }
        selectors.expandAllBtn.addEventListener('click', () => toggleAllCategories(false));
        selectors.collapseAllBtn.addEventListener('click', () => toggleAllCategories(true));
        selectors.reorderToggleBtn.addEventListener('click', () => { const isActive = selectors.budgetCategoriesList.classList.toggle('reordering-active'); selectors.reorderToggleBtn.textContent = isActive ? 'Done' : 'Reorder'; renderBudgetCategories(); });
        selectors.manageAccountsBtn.addEventListener('click', () => { selectors.sharableIdDisplay.value = currentBudgetId; selectors.editAccountNameInput.value = state.accountName || ''; selectors.accountsModal.style.display = 'flex'; });
        selectors.saveAccountNameBtn.addEventListener('click', () => { const newName = selectors.editAccountNameInput.value.trim(); if (newName) { set(ref(db, `budgets/${currentBudgetId}/accountName`), newName); selectors.saveAccountNameBtn.textContent = 'Saved!'; setTimeout(() => { selectors.saveAccountNameBtn.textContent = 'Save'; closeModal(selectors.accountsModal); }, 1000); } else { alert('Please enter a valid budget name.'); } });
        selectors.copyIdBtn.addEventListener('click', () => { selectors.sharableIdDisplay.select(); document.execCommand('copy'); selectors.copyIdBtn.textContent = 'Copied!'; setTimeout(() => { selectors.copyIdBtn.textContent = 'Copy'; }, 1500); });
        selectors.leaveBudgetBtn.addEventListener('click', () => { localStorage.removeItem('lastBudgetId'); window.location.reload(); });
        const closeModal = (modal) => modal.style.display = 'none';
        selectors.closeReviewModalBtn.addEventListener('click', () => closeModal(selectors.reviewModal));
        selectors.closeAccountsModalBtn.addEventListener('click', () => closeModal(selectors.accountsModal));
        selectors.noHistoryCloseBtn.addEventListener('click', () => closeModal(selectors.reviewModal));
        window.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeModal(selectors.reviewModal); closeModal(selectors.accountsModal); selectors.confirmModal.style.display = 'none'; } });
        selectors.reviewBtn.addEventListener('click', () => { selectors.monthSelect.innerHTML = ''; if (history.length === 0) { selectors.chartsArea.style.display = 'none'; selectors.reviewControls.style.display = 'none'; selectors.noHistoryMsg.style.display = 'block'; } else { selectors.chartsArea.style.display = 'grid'; selectors.reviewControls.style.display = 'block'; selectors.noHistoryMsg.style.display = 'none'; history.forEach((month, index) => { const option = document.createElement('option'); option.value = index; option.textContent = month.monthYear; selectors.monthSelect.appendChild(option); }); selectors.monthSelect.dispatchEvent(new Event('change')); } selectors.reviewModal.style.display = 'flex'; });
        selectors.monthSelect.addEventListener('change', (e) => { const selectedMonthData = history[e.target.value]; createCashflowChart(selectedMonthData); createSpendingChart(selectedMonthData); });

        document.body.addEventListener('click', async (e) => {
            const categoryHeader = e.target.closest('.budget-category-header');
            if (categoryHeader && !e.target.closest('.icon-btn') && !e.target.closest('.move-btn')) { const key = categoryHeader.dataset.key; const currentCollapsedState = state.budgetedItems[key]?.collapsed || false; set(ref(db, `budgets/${currentBudgetId}/budgetedItems/${key}/collapsed`), !currentCollapsedState); return; }

            const button = e.target.closest('button');
            if (!button) return;

            if (button.classList.contains('move-up-btn') || button.classList.contains('move-down-btn')) {
                const keyToMove = button.dataset.key;
                let sortedCategories = Object.entries(state.budgetedItems).sort((a, b) => a[1].order - b[1].order);
                const currentIndex = sortedCategories.findIndex(([key, cat]) => key === keyToMove);
                if (currentIndex === -1) return;
                const isMovingUp = button.classList.contains('move-up-btn');
                const swapIndex = isMovingUp ? currentIndex - 1 : currentIndex + 1;
                if (swapIndex >= 0 && swapIndex < sortedCategories.length) {
                    const [key1, cat1] = sortedCategories[currentIndex];
                    const [key2, cat2] = sortedCategories[swapIndex];
                    const updates = {};
                    updates[`/budgetedItems/${key1}/order`] = cat2.order;
                    updates[`/budgetedItems/${key2}/order`] = cat1.order;
                    update(dbRef, updates);
                }
                return;
            }

            const { key, type, categoryKey, expenseKey } = button.dataset;
            const dbPath = type === 'income' ? 'income' : 'monthlyExpenses';

            if (button.classList.contains('delete-expense-btn')) { if (await showConfirm(`Are you sure you want to delete this expense?`)) { remove(ref(db, `budgets/${currentBudgetId}/budgetedItems/${categoryKey}/expenses/${expenseKey}`)); } } 
            else if (button.classList.contains('delete-btn')) { if (await showConfirm(`Are you sure you want to delete this item?`)) { if (type === 'income' || type === 'expense') { remove(ref(db, `budgets/${currentBudgetId}/${dbPath}/${key}`)); } else if (type === 'category') { remove(ref(db, `budgets/${currentBudgetId}/budgetedItems/${key}`)); } } } 
            else if (button.classList.contains('add-expense-to-category-btn')) { const form = button.closest('.new-expense-form'); const categoryKey = form.closest('.budget-category').querySelector('.budget-category-header').dataset.key; const amountInput = form.querySelector('.expense-amount-input'); const noteInput = form.querySelector('.expense-note-input'); const amount = parseFloat(amountInput.value); const note = noteInput.value.trim(); if (amount > 0) { push(ref(db, `budgets/${currentBudgetId}/budgetedItems/${categoryKey}/expenses`), { amount, note, date: new Date().toLocaleDateString(), isEditing: false }); amountInput.value = ''; noteInput.value = ''; } else { alert('Please enter a valid amount.'); } } 
            else if (button.classList.contains('edit-item-btn')) { set(ref(db, `budgets/${currentBudgetId}/${dbPath}/${key}/isEditing`), true); }
            else if (button.classList.contains('cancel-item-btn')) { set(ref(db, `budgets/${currentBudgetId}/${dbPath}/${key}/isEditing`), false); }
            else if (button.classList.contains('save-item-btn')) { const form = button.closest('.input-group'); const newName = form.querySelector('.edit-item-name-input').value.trim(); const newAmount = parseFloat(form.querySelector('.edit-item-amount-input').value); if (newName && newAmount > 0) { update(ref(db, `budgets/${currentBudgetId}/${dbPath}/${key}`), { name: newName, amount: newAmount, isEditing: false }); } else { alert('Please enter a valid name and amount.'); } }
            else if (button.classList.contains('edit-btn')) { if (button.classList.contains('edit-expense-btn')) { set(ref(db, `budgets/${currentBudgetId}/budgetedItems/${categoryKey}/expenses/${expenseKey}/isEditing`), true); } else { set(ref(db, `budgets/${currentBudgetId}/budgetedItems/${key}/isEditing`), true); } } 
            else if (button.classList.contains('save-edit-btn')) { const form = button.closest('.edit-category-form'); const newName = form.querySelector('.edit-name-input').value.trim(); const newLimit = parseFloat(form.querySelector('.edit-limit-input').value); if (newName && newLimit > 0) { update(ref(db, `budgets/${currentBudgetId}/budgetedItems/${key}`), { name: newName, limit: newLimit, isEditing: false }); } else { alert('Please enter a valid name and limit.'); } } 
            else if (button.classList.contains('save-edit-expense-btn')) { const form = button.closest('li'); const newAmount = parseFloat(form.querySelector('.edit-expense-amount-input').value); const newNote = form.querySelector('.edit-expense-note-input').value.trim(); if (newAmount > 0) { const originalDate = state.budgetedItems[categoryKey].expenses[expenseKey].date; update(ref(db, `budgets/${currentBudgetId}/budgetedItems/${categoryKey}/expenses/${expenseKey}`), { date: originalDate, amount: newAmount, note: newNote, isEditing: false }); } else { alert('Please enter a valid amount.'); } } 
            else if (button.classList.contains('cancel-edit-btn')) { set(ref(db, `budgets/${currentBudgetId}/budgetedItems/${key}/isEditing`), false); } 
            else if (button.classList.contains('cancel-edit-expense-btn')) { set(ref(db, `budgets/${currentBudgetId}/budgetedItems/${categoryKey}/expenses/${expenseKey}/isEditing`), false); }
        });
        
        const lastBudgetId = localStorage.getItem('lastBudgetId');
        if (lastBudgetId) { connectToBudget(lastBudgetId); }
    </script>
</body>
</html>